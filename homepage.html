<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניי שרייר - המרכזת גורמי אנוש</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            direction: rtl;
            line-height: 1.6;
        }

        .header {
            background-color: #1e3a8a;
            color: white;
            padding: 15px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.2em;
            margin: 0;
        }

        .user-icon {
            background-color: white;
            color: #1e3a8a;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .navigation {
            display: flex;
            gap: 10px;
            padding: 15px;
            background-color: white;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-btn {
            padding: 10px 20px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background-color: #f0f0f0;
        }

        .nav-btn.active {
            background-color: #1e3a8a;
            color: white;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            direction: rtl;
        }

        .toggle-btn {
            display: flex;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .toggle-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-option.active {
            background-color: #1e3a8a;
            color: white;
        }

        /* New styles for improved auth system */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background-color: #1e3a8a;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .forgot-password-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #1e3a8a;
            text-decoration: none;
            font-size: 14px;
        }

        .forgot-password-link:hover {
            text-decoration: underline;
        }

        .back-to-login {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
        }

        .back-to-login:hover {
            text-decoration: underline;
        }

        .error-message {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .success-message {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        #forgot-password-form {
            display: none;
        }

        #forgot-password-form.active {
            display: block;
        }

        .total-display {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-top: 15px;
        }

        .hidden {
            display: none;
        }

        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .popup-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 5px;
        }

        .calendar-nav button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px 10px;
        }

        .number-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .number-input button {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 3px;
        }

        .number-input input {
            width: 80px;
            text-align: center;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background-color: #1e3a8a;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #1e40af;
        }

        .btn.secondary {
            background-color: #6b7280;
        }

        .btn.add {
            background-color: transparent;
            color: #1e3a8a;
            border: 1px solid #ddd;
            font-size: 14px;
            padding: 10px;
            margin-top: 10px;
        }

        .notification {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 20px 0;
        }

        .calendar-header {
            text-align: center;
            padding: 10px;
            background-color: #f9fafb;
            font-weight: bold;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .calendar-day:hover {
            background-color: #f3f4f6;
        }

        .calendar-day.today {
            background-color: #dbeafe;
            color: #1e3a8a;
            font-weight: bold;
        }

        .calendar-day.selected {
            background-color: #1e3a8a;
            color: white;
        }

        .calendar-day.has-report {
            background-color: #dcfce7;
            color: #166534;
        }

        .work-entry {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .remove-btn {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: #dc2626;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .researchers-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }

        .researcher-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .researcher-item:last-child {
            border-bottom: none;
        }

        .researcher-item input[type="checkbox"] {
            width: auto;
        }

        .researcher-item label {
            margin: 0;
            font-weight: normal;
        }
        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            .navigation {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .nav-btn {
                flex: 1;
                min-width: 100px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="user-icon" onclick="showScreen('user-profile')">👤</div>
        <h1>ניי שרייר - המרכזת גורמי אנוש</h1>
        <div onclick="showScreen('main')" style="cursor: pointer;">🏠</div>
    </div>

    <!-- Navigation -->
    <div class="navigation">
        <button class="nav-btn" onclick="showScreen('reports')">דוחות</button>
        <button class="nav-btn" onclick="showScreen('calendar')">יומן</button>
        <button class="nav-btn active" onclick="showScreen('main')">בית</button>
        <button class="nav-btn" onclick="showScreen('active-researchers')">חוקרים פעילים</button>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="auth-container">
        <h2 style="text-align: center; margin-bottom: 30px;">כניסה למערכת</h2>

        <!-- Auth Tabs -->
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">התחברות</button>
            <button class="auth-tab" onclick="switchAuthTab('register')">הרשמה</button>
        </div>

        <!-- Login Form -->
        <div id="login-form" class="auth-form active">
            <div id="login-messages"></div>
            <form id="signin-form">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label>סיסמה:</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn">התחבר</button>
                <a href="#" class="forgot-password-link" onclick="showForgotPassword()">שכחתי סיסמה</a>
            </form>
        </div>

        <!-- Register Form -->
        <div id="register-form" class="auth-form">
            <div id="register-messages"></div>
            <form id="signup-form">
                <div class="form-group">
                    <label>שם פרטי:</label>
                    <input type="text" id="register-first-name" required>
                </div>
                <div class="form-group">
                    <label>שם משפחה:</label>
                    <input type="text" id="register-last-name" required>
                </div>
                <div class="form-group">
                    <label>תפקיד:</label>
                    <input type="text" id="register-position" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label>סיסמה:</label>
                    <input type="password" id="register-password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>אימות סיסמה:</label>
                    <input type="password" id="register-confirm-password" required minlength="6">
                </div>
                <button type="submit" class="btn">הרשם</button>
            </form>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgot-password-form">
            <h3 style="text-align: center; margin-bottom: 20px;">שחזור סיסמה</h3>
            <div id="forgot-password-messages"></div>
            <form id="reset-password-form">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="reset-email" required>
                </div>
                <button type="submit" class="btn">שלח קישור לשחזור</button>
                <a href="#" class="back-to-login" onclick="backToLogin()">חזרה להתחברות</a>
            </form>
        </div>
    </div>

    <!-- Main Screen -->
    <div id="main-screen" class="container hidden">
        <div id="notifications"></div>
        
        <button class="btn" id="add-report-btn" onclick="addNewReport()">+ הוסף דיווח</button>
        
        <div id="messages" style="margin-top: 30px;">
            <h3>הודעות</h3>
            <div id="missing-reports"></div>
        </div>
    </div>

    <!-- User Profile Screen -->
    <div id="user-profile-screen" class="container hidden">
        <h2 style="text-align: center; margin-bottom: 30px;">פרטי העובד</h2>
        <div class="form-group">
            <label>שם פרטי:</label>
            <input type="text" id="profile-first-name" readonly>
        </div>
        <div class="form-group">
            <label>שם משפחה:</label>
            <input type="text" id="profile-last-name" readonly>
        </div>
        <div class="form-group">
            <label>תפקיד:</label>
            <input type="text" id="profile-position" readonly>
        </div>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="profile-email" readonly>
        </div>
        <div class="form-group">
            <label>סיסמה:</label>
            <input type="password" id="profile-password" value="************" readonly>
        </div>
        <button class="btn" onclick="editProfile()">ערוך</button>
    </div>

    <!-- Active Researchers Screen -->
    <div id="active-researchers-screen" class="container hidden">
        <h2 style="text-align: center; margin-bottom: 30px;">חוקרים פעילים</h2>
        <div class="researchers-list" id="researchers-list">
            <!-- Will be populated by JavaScript -->
        </div>
        <button class="btn" onclick="saveResearchers()">שמור</button>
    </div>

    <!-- Calendar Screen -->
    <div id="calendar-screen" class="container hidden">
        <div class="calendar-nav">
            <button onclick="previousMonth()">❮</button>
            <h3 id="calendar-title"></h3>
            <button onclick="nextMonth()">❯</button>
        </div>
        
        <div class="calendar" id="calendar-grid"></div>
        
        <button class="btn add" onclick="addCalendarReport()">+ הוסף דיווח</button>
    </div>

    <!-- Reports Screen -->
    <div id="reports-screen" class="container hidden">
        <h2 style="text-align: center; margin-bottom: 30px;">דוחות</h2>
        <div class="form-group">
            <label>חודש:</label>
            <select id="report-month">
                <option value="1">ינואר</option>
                <option value="2">פברואר</option>
                <option value="3">מרץ</option>
                <option value="4">אפריל</option>
                <option value="5">מאי</option>
                <option value="6">יוני</option>
                <option value="7">יולי</option>
                <option value="8">אוגוסט</option>
                <option value="9">ספטמבר</option>
                <option value="10">אוקטובר</option>
                <option value="11">נובמבר</option>
                <option value="12">דצמבר</option>
            </select>
        </div>
        <div class="form-group">
            <label>שנה:</label>
            <select id="report-year"></select>
        </div>
        <button class="btn" onclick="generateReport()">הצג דוח</button>
        
        <div id="report-results" style="margin-top: 30px;"></div>
    </div>

    <!-- Daily Report Screen -->
    <div id="daily-report-screen" class="container hidden">
        <h2 style="text-align: center; margin-bottom: 30px;">דיווח חדש</h2>
        
        <div class="toggle-btn" id="report-type-toggle">
            <div class="toggle-option active" data-type="daily">יומי</div>
            <div class="toggle-option" data-type="weekly">שבועי</div>
        </div>
        
        <div class="form-group">
            <label>תאריך:</label>
            <input type="date" id="report-date">
        </div>
        
        <div id="daily-form">
            <div class="toggle-btn" id="work-status-toggle">
                <div class="toggle-option" data-status="no-work">לא עבדתי</div>
                <div class="toggle-option active" data-status="worked">עבדתי</div>
            </div>
            
            <div id="work-entries"></div>
            <button class="btn add" onclick="addWorkEntry()">+</button>
            
            <div class="total-display">
                <strong>סה"כ שעות: <span id="total-hours">0</span></strong>
            </div>
        </div>
        
        <div id="weekly-form" class="hidden">
            <div class="form-group">
                <label>שבוע:</label>
                <input type="week" id="report-week" readonly>
            </div>
            
            <div id="weekly-entries"></div>
            <button class="btn add" onclick="addWeeklyEntry()">+</button>
            
            <div class="total-display">
                <strong>סה"כ ימים: <span id="total-days">0</span></strong>
            </div>
        </div>
        
        <button class="btn" onclick="submitReport()">הוסף</button>
        <button class="btn secondary" onclick="showScreen('main')">ביטול</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDpzAnHPl8trZDQwC-G5twRWSwdweko_T8",
            authDomain: "work-report-volcani.firebaseapp.com",
            projectId: "work-report-volcani",
            storageBucket: "work-report-volcani.firebasestorage.app",
            messagingSenderId: "569559789764",
            appId: "1:569559789764:web:d11b9c0e43ff78a66dd991",
            measurementId: "G-M5Z4R1FB40",
            databaseURL: "https://work-report-volcani-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Application State
        let currentUser = null;
        let activeResearchers = [];
        let reports = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let currentWeek = getCurrentWeek();

        // Researchers list
        const allResearchers = [
            'חוקר 1', 'חוקר 2', 'חוקר 3', 'חוקר 4', 'חוקר 5',
            'חוקר 6', 'חוקר 7', 'חוקר 8', 'חוקר 9', 'חוקר 10',
            'חוקר 11', 'חוקר 12', 'חוקר 13', 'חוקר 14', 'חוקר 15'
        ];

        // Initialize app
        function init() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in, but we stay on the login screen.
                    // Pre-fill the email address.
                    document.getElementById('email').value = user.email;

                    // We keep the currentUser object ready for when they log in.
                    currentUser = user;
                }
                // Always start on the login screen, which is the default.
                showScreen('login');
            });
        }

        // Authentication functions
        function createUser(userData) {
            return auth.createUserWithEmailAndPassword(userData.email, userData.password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    // Save user profile to database
                    return database.ref('users/' + user.uid).set({
                        firstName: userData.firstName,
                        lastName: userData.lastName,
                        position: userData.position,
                        email: userData.email,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                })
                .then(() => {
                    showPopup('המשתמש נרשם בהצלחה!');
                })
                .catch((error) => {
                    console.error('Error creating user:', error);
                    alert('שגיאה ביצירת המשתמש: ' + error.message);
                });
        }

        function signInUser(email, password) {
            return auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    console.error('Error signing in:', error);
                    alert('שגיאה בהתחברות: ' + error.message);
                });
        }

        function loadUserProfile(uid) {
            database.ref('users/' + uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        document.getElementById('profile-first-name').value = userData.firstName;
                        document.getElementById('profile-last-name').value = userData.lastName;
                        document.getElementById('profile-position').value = userData.position;
                        document.getElementById('profile-email').value = userData.email;
                    }
                })
                .catch((error) => {
                    console.error('Error loading user profile:', error);
                });
        }

        function updateUserProfile(uid, userData) {
            return database.ref('users/' + uid).update(userData)
                .then(() => {
                    showPopup('הפרטים עודכנו בהצלחה!');
                })
                .catch((error) => {
                    console.error('Error updating profile:', error);
                    alert('שגיאה בעדכון הפרטים: ' + error.message);
                });
        }


        function onLoginSuccess(user) {
            currentUser = user;
            loadUserProfile(user.uid);
            loadActiveResearchers(user.uid);
            loadReports(user.uid);
            initializeDates();
            updateNotifications();
            showScreen('main');
        }


        // Screen management
        function showScreen(screenName) {
            const screens = ['login', 'main', 'user-profile', 'active-researchers', 'calendar', 'reports', 'daily-report'];
            screens.forEach(screen => {
                document.getElementById(screen + '-screen').classList.add('hidden');
            });
            document.getElementById(screenName + '-screen').classList.remove('hidden');
            
            // Update navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (screenName === 'main') {
                document.querySelector('.nav-btn[onclick="showScreen(\'main\')"]').classList.add('active');
                updateNotifications();
            } else if (screenName === 'calendar') {
                document.querySelector('.nav-btn[onclick="showScreen(\'calendar\')"]').classList.add('active');
                renderCalendar();
            } else if (screenName === 'reports') {
                document.querySelector('.nav-btn[onclick="showScreen(\'reports\')"]').classList.add('active');
                initializeReportScreen();
            } else if (screenName === 'active-researchers') {
                document.querySelector('.nav-btn[onclick="showScreen(\'active-researchers\')"]').classList.add('active');
                renderResearchers();
            }
        }

        // Login functionality
        document.getElementById('signin-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            signInUser(email, password)
                .then(() => {
                    const user = auth.currentUser;
                    if (user) {
                        onLoginSuccess(user);
                    }
                })
                .catch((error) => {
                    document.getElementById('login-messages').innerHTML = `<div class="error-message">${error.message}</div>`;
                });
        });

        document.getElementById('signup-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const userData = {
                firstName: document.getElementById('register-first-name').value,
                lastName: document.getElementById('register-last-name').value,
                position: document.getElementById('register-position').value,
                email: document.getElementById('register-email').value,
                password: document.getElementById('register-password').value
            };

            // Validate password confirmation
            const confirmPassword = document.getElementById('register-confirm-password').value;
            if (userData.password !== confirmPassword) {
                document.getElementById('register-messages').innerHTML = '<div class="error-message">סיסמאות אינן תואמות</div>';
                return;
            }

            createUser(userData)
                .then(() => {
                    // Auto sign in after registration
                    return signInUser(userData.email, userData.password);
                })
                .then(() => {
                    const user = auth.currentUser;
                    if (user) {
                        onLoginSuccess(user);
                    }
                })
                .catch((error) => {
                    document.getElementById('register-messages').innerHTML = `<div class="error-message">${error.message}</div>`;
                });
        });

        function showForgotPassword() {
            document.getElementById('login-form').classList.remove('active');
            document.getElementById('forgot-password-form').classList.add('active');
        }

        function backToLogin() {
            document.getElementById('forgot-password-form').classList.remove('active');
            document.getElementById('login-form').classList.add('active');
        }

        document.getElementById('reset-password-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const email = document.getElementById('reset-email').value;

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    document.getElementById('forgot-password-messages').innerHTML = '<div class="success-message">קישור לשחזור סיסמה נשלח למייל שלך</div>';
                })
                .catch((error) => {
                    document.getElementById('forgot-password-messages').innerHTML = `<div class="error-message">${error.message}</div>`;
                });
        });

        function editProfile() {
            const inputs = document.querySelectorAll('#user-profile-screen input');
            const isReadonly = inputs[0].hasAttribute('readonly');
            
            if (isReadonly) {
                inputs.forEach(input => {
                    if (input.type !== 'password' && input.type !== 'email') {
                        input.removeAttribute('readonly');
                        input.style.backgroundColor = 'white';
                    }
                });
                document.querySelector('#user-profile-screen .btn').textContent = 'שמור';
            } else {
                // Save changes to Firebase
                const updatedData = {
                    firstName: document.getElementById('profile-first-name').value,
                    lastName: document.getElementById('profile-last-name').value,
                    position: document.getElementById('profile-position').value
                };
                
                updateUserProfile(currentUser.uid, updatedData)
                    .then(() => {
                        inputs.forEach(input => {
                            input.setAttribute('readonly', true);
                            input.style.backgroundColor = '#f9fafb';
                        });
                        document.querySelector('#user-profile-screen .btn').textContent = 'ערוך';
                    });
            }
        }

        // Researchers management
        function renderResearchers() {
            const container = document.getElementById('researchers-list');
            container.innerHTML = '';
            
            allResearchers.forEach(researcher => {
                const div = document.createElement('div');
                div.className = 'researcher-item';
                div.innerHTML = `
                    <input type="checkbox" id="researcher-${researcher}" ${activeResearchers.includes(researcher) ? 'checked' : ''}>
                    <label for="researcher-${researcher}">${researcher}</label>
                `;
                container.appendChild(div);
            });
            
            // Add fixed items
            ['משימה אחרות', 'סמינר / קורס / הכשרה'].forEach(item => {
                const div = document.createElement('div');
                div.className = 'researcher-item';
                div.innerHTML = `
                    <input type="checkbox" checked disabled>
                    <label>${item}</label>
                `;
                container.appendChild(div);
            });
        }

        function saveResearchers() {
            activeResearchers = [];
            document.querySelectorAll('#researchers-list input[type="checkbox"]:checked:not([disabled])').forEach(checkbox => {
                const researcher = checkbox.id.replace('researcher-', '');
                activeResearchers.push(researcher);
            });
            
            // Save to Firebase
            if (currentUser) {
                database.ref('users/' + currentUser.uid + '/activeResearchers').set(activeResearchers)
                    .then(() => {
                        showPopup('החוקרים הפעילים נשמרו בהצלחה');
                    })
                    .catch((error) => {
                        console.error('Error saving researchers:', error);
                        alert('שגיאה בשמירת החוקרים: ' + error.message);
                    });
            }
        }

        function loadActiveResearchers(uid) {
            if (!uid) return;
            
            database.ref('users/' + uid + '/activeResearchers').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        activeResearchers = data;
                    } else {
                        activeResearchers = allResearchers.slice(0, 5); // Default selection
                    }
                })
                .catch((error) => {
                    console.error('Error loading researchers:', error);
                    activeResearchers = allResearchers.slice(0, 5); // Fallback
                });
        }

        // Calendar functionality
        function renderCalendar() {
            const monthNames = [
                'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
                'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'
            ];
            
            document.getElementById('calendar-title').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
            dayHeaders.forEach(day => {
                const div = document.createElement('div');
                div.className = 'calendar-header';
                div.textContent = day;
                grid.appendChild(div);
            });
            
            // Days of the month
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            
            // Empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                grid.appendChild(div);
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.textContent = day;
                
                const date = new Date(currentYear, currentMonth, day);
                const dateString = formatDate(date);
                
                // Check if it's today
                if (date.toDateString() === today.toDateString()) {
                    div.classList.add('today');
                }
                
                // Check if there's a report for this day
                if (reports.some(report => report.date === dateString)) {
                    div.classList.add('has-report');
                }
                
                // Don't allow work reports on Friday/Saturday
                if (date.getDay() === 5 || date.getDay() === 6) {
                    div.style.backgroundColor = '#f3f4f6';
                    div.style.color = '#9ca3af';
                }
                
                div.addEventListener('click', () => {
                    if (date.getDay() === 5 || date.getDay() === 6) return;
                    
                    document.querySelectorAll('.calendar-day.selected').forEach(d => {
                        d.classList.remove('selected');
                    });
                    div.classList.add('selected');
                    selectedDate = date;
                });
                
                grid.appendChild(div);
            }
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        function addCalendarReport() {
            if (!selectedDate) {
                alert('אנא בחר תאריך');
                return;
            }
            
            const now = new Date();
            const weekStart = getWeekStart(now);
            const selectedWeekStart = getWeekStart(selectedDate);
            
            if (selectedDate < weekStart) {
                if (reports.some(report => report.date === formatDate(selectedDate))) {
                    alert('לא ניתן לערוך דיווח קיים');
                    return;
                }
            }
            
            document.getElementById('report-date').value = formatDate(selectedDate);
            showScreen('daily-report');
        }

        // Report functionality
        function addNewReport() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            document.getElementById('report-date').value = formatDate(today);
            
            // Show weekly option only on Thursday
            const weeklyToggle = document.querySelector('[data-type="weekly"]');
            if (dayOfWeek === 4) { // Thursday
                weeklyToggle.style.display = 'block';
            } else {
                weeklyToggle.style.display = 'none';
                selectReportType('daily');
            }
            
            showScreen('daily-report');
        }

        function selectReportType(type) {
            document.querySelectorAll('.toggle-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            if (type === 'daily') {
                document.getElementById('daily-form').classList.remove('hidden');
                document.getElementById('weekly-form').classList.add('hidden');
            } else {
                document.getElementById('daily-form').classList.add('hidden');
                document.getElementById('weekly-form').classList.remove('hidden');
                document.getElementById('report-week').value = currentWeek;
            }
        }

        function selectWorkStatus(status) {
            document.querySelectorAll('#work-status-toggle .toggle-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            const workEntries = document.getElementById('work-entries');
            if (status === 'no-work') {
                workEntries.innerHTML = '';
                workEntries.style.display = 'none';
                document.querySelector('.btn.add').style.display = 'none';
                updateTotalHours();
            } else {
                workEntries.style.display = 'block';
                document.querySelector('.btn.add').style.display = 'block';
                if (workEntries.children.length === 0) {
                    addWorkEntry();
                }
            }
        }

        function addWorkEntry() {
            const container = document.getElementById('work-entries');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'work-entry';
            
            const availableResearchers = [...activeResearchers, 'משימה אחרות', 'סמינר / קורס / הכשרה'];
            
            entryDiv.innerHTML = `
                ${container.children.length > 0 ? '<button class="remove-btn" onclick="removeEntry(this)">×</button>' : ''}
                <div class="form-group">
                    <label>חוקר/משימה:</label>
                    <select class="researcher-select" onchange="toggleDetailField(this)">
                        <option value="">בחר חוקר/משימה</option>
                        ${availableResearchers.map(r => `<option value="${r}">${r}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group detail-field" style="display: none;">
                    <label>פרט:</label>
                    <textarea rows="2" placeholder="הוסף פרטים נוספים..."></textarea>
                </div>
                <div class="form-group">
                    <label>שעות:</label>
                    <div class="number-input">
                        <button type="button" onclick="changeHours(this, -0.5)">-</button>
                        <input type="number" class="hours-input" value="0" min="0" step="0.5" onchange="updateTotalHours()">
                        <button type="button" onclick="changeHours(this, 0.5)">+</button>
                    </div>
                </div>
            `;
            
            container.appendChild(entryDiv);
            updateTotalHours();
        }

        function addWeeklyEntry() {
            const container = document.getElementById('weekly-entries');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'work-entry';
            
            const availableResearchers = [...activeResearchers, 'משימה אחרות', 'סמינר / קורס / הכשרה'];
            
            entryDiv.innerHTML = `
                ${container.children.length > 0 ? '<button class="remove-btn" onclick="removeEntry(this)">×</button>' : ''}
                <div class="form-group">
                    <label>חוקר/פרויקט:</label>
                    <select class="researcher-select" onchange="toggleDetailField(this)">
                        <option value="">בחר חוקר/פרויקט</option>
                        ${availableResearchers.map(r => `<option value="${r}">${r}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group detail-field" style="display: none;">
                    <label>פרט:</label>
                    <textarea rows="2" placeholder="הוסף פרטים נוספים..."></textarea>
                </div>
                <div class="form-group">
                    <label>ימים:</label>
                    <div class="number-input">
                        <button type="button" onclick="changeDays(this, -0.25)">-</button>
                        <input type="number" class="days-input" value="0" min="0" max="5" step="0.25" onchange="updateTotalDays()">
                        <button type="button" onclick="changeDays(this, 0.25)">+</button>
                    </div>
                </div>
            `;
            
            container.appendChild(entryDiv);
            updateTotalDays();
        }

        function toggleDetailField(selectElement) {
            const entry = selectElement.closest('.work-entry');
            const detailField = entry.querySelector('.detail-field');
            const selectedValue = selectElement.value;
            
            if (selectedValue === 'משימה אחרות' || selectedValue === 'סמינר / קורס / הכשרה') {
                detailField.style.display = 'block';
            } else {
                detailField.style.display = 'none';
            }
        }

        function changeHours(button, change) {
            const input = button.parentElement.querySelector('.hours-input');
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, currentValue + change);
            input.value = newValue;
            updateTotalHours();
        }

        function changeDays(button, change) {
            const input = button.parentElement.querySelector('.days-input');
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, Math.min(5, currentValue + change));
            input.value = newValue;
            updateTotalDays();
        }

        function removeEntry(button) {
            button.parentElement.remove();
            updateTotalHours();
            updateTotalDays();
        }

        function updateTotalHours() {
            const hoursInputs = document.querySelectorAll('.hours-input');
            let total = 0;
            hoursInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById('total-hours').textContent = total;
        }

        function updateTotalDays() {
            const daysInputs = document.querySelectorAll('.days-input');
            let total = 0;
            daysInputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById('total-days').textContent = total;
        }


        function submitReport() {
            const reportDate = document.getElementById('report-date').value;
            if (!reportDate) {
                alert('אנא הזן תאריך');
                return;
            }

            const selectedDate = new Date(reportDate);
            if (selectedDate.getDay() === 5 || selectedDate.getDay() === 6) {
                alert('לא ניתן לדווח עבודה בימי שישי ושבת');
                return;
            }

            const isWeekly = !document.getElementById('daily-form').classList.contains('hidden') ? false : true;
            
            let reportData = {
                date: reportDate,
                type: isWeekly ? 'weekly' : 'daily',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                entries: []
            };

            if (!isWeekly) {
                // Daily report
                const workStatus = document.querySelector('#work-status-toggle .toggle-option.active').dataset.status;
                reportData.workStatus = workStatus;
                
                if (workStatus === 'worked') {
                    const entries = document.querySelectorAll('#work-entries .work-entry');
                    entries.forEach(entry => {
                        const researcher = entry.querySelector('.researcher-select').value;
                        const hours = parseFloat(entry.querySelector('.hours-input').value) || 0;
                        const detail = entry.querySelector('textarea') ? entry.querySelector('textarea').value : '';
                        
                        if (researcher && hours > 0) {
                            reportData.entries.push({
                                researcher,
                                hours,
                                detail
                            });
                        }
                    });
                }
            } else {
                // Weekly report
                const week = document.getElementById('report-week').value;
                reportData.week = week;
                
                const entries = document.querySelectorAll('#weekly-entries .work-entry');
                entries.forEach(entry => {
                    const researcher = entry.querySelector('.researcher-select').value;
                    const days = parseFloat(entry.querySelector('.days-input').value) || 0;
                    const detail = entry.querySelector('textarea') ? entry.querySelector('textarea').value : '';
                    
                    if (researcher && days > 0) {
                        reportData.entries.push({
                            researcher,
                            days,
                            detail
                        });
                    }
                });
            }

            // Save to Firebase
            if (currentUser) {
                const reportKey = isWeekly ? `weekly_${reportData.week}` : `daily_${reportData.date}`;
                
                database.ref('reports/' + currentUser.uid + '/' + reportKey).set(reportData)
                    .then(() => {
                        showPopup('הדיווח נוסף בהצלחה!');
                        setTimeout(() => {
                            showScreen('main');
                            clearReportForm();
                            loadReports(currentUser.uid);
                        }, 2000);
                    })
                    .catch((error) => {
                        console.error('Error saving report:', error);
                        alert('שגיאה בשמירת הדיווח: ' + error.message);
                    });
            }
        }

        function loadReports(uid) {
            if (!uid) return;
            
            database.ref('reports/' + uid).on('value', (snapshot) => {
                const data = snapshot.val();
                reports = data ? Object.values(data) : [];
                updateNotifications();
                if (document.getElementById('calendar-screen').classList.contains('hidden') === false) {
                    renderCalendar();
                }
            });
        }

        function saveReports() {
            // This function is no longer needed as we save directly to Firebase
            // Keeping it for compatibility
        }

        function showPopup(message) {
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="success-message">${message}</div>
                </div>
            `;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                document.body.removeChild(popup);
            }, 2000);
        }

        // Authentication UI functions
        function switchAuthTab(tabType) {
            // Remove active class from all tabs and forms
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });

            // Hide forgot password form
            document.getElementById('forgot-password-form').classList.remove('active');

            // Activate selected tab and form
            document.querySelector(`[onclick="switchAuthTab('${tabType}')"]`).classList.add('active');
            document.getElementById(`${tabType}-form`).classList.add('active');

            // Clear messages
            document.getElementById('login-messages').innerHTML = '';
            document.getElementById('register-messages').innerHTML = '';
        }

        // Clear report form
        function clearReportForm() {
            document.getElementById('work-entries').innerHTML = '';
            document.getElementById('weekly-entries').innerHTML = '';
            document.getElementById('total-hours').textContent = '0';
            document.getElementById('total-days').textContent = '0';
            selectWorkStatus('worked');
            selectReportType('daily');
        }

        // Helper functions
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getCurrentWeek() {
            const now = new Date();
            const year = now.getFullYear();
            const week = Math.ceil((((now - new Date(year, 0, 1)) / 86400000) + new Date(year, 0, 1).getDay() + 1) / 7);
            return `${year}-W${week.toString().padStart(2, '0')}`;
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            return new Date(d.setDate(diff));
        }

        function initializeDates() {
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            currentWeek = getCurrentWeek();
        }

        function updateNotifications() {
            const notificationsDiv = document.getElementById('notifications');
            const missingReportsDiv = document.getElementById('missing-reports');

            if (!notificationsDiv || !missingReportsDiv) return;

            notificationsDiv.innerHTML = '';
            missingReportsDiv.innerHTML = '';

            const today = new Date();
            const currentWeekStart = getWeekStart(today);

            // Check for missing daily reports from current week
            let missingDays = [];
            for (let i = 0; i < 5; i++) { // Monday to Friday
                const checkDate = new Date(currentWeekStart);
                checkDate.setDate(currentWeekStart.getDate() + i);

                if (checkDate <= today) {
                    const dateString = formatDate(checkDate);
                    const hasReport = reports.some(report => report.date === dateString && report.type === 'daily');

                    if (!hasReport) {
                        missingDays.push(checkDate);
                    }
                }
            }

            if (missingDays.length > 0) {
                const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
                const missingDaysText = missingDays.map(date => {
                    return `${dayNames[date.getDay()]} (${date.getDate()}/${date.getMonth() + 1})`;
                }).join(', ');

                missingReportsDiv.innerHTML = `
                    <div class="notification">
                        <strong>חסרים דיווחים עבור:</strong><br>
                        ${missingDaysText}
                    </div>
                `;
            }
        }

        function initializeReportScreen() {
            const yearSelect = document.getElementById('report-year');
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            // Populate year select
            yearSelect.innerHTML = '';
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }

            // Set current month
            document.getElementById('report-month').value = currentMonth;
        }

        function generateReport() {
            const month = parseInt(document.getElementById('report-month').value);
            const year = parseInt(document.getElementById('report-year').value);
            const resultsDiv = document.getElementById('report-results');

            // Filter reports for selected month/year
            const monthReports = reports.filter(report => {
                const reportDate = new Date(report.date);
                return reportDate.getMonth() + 1 === month && reportDate.getFullYear() === year;
            });

            if (monthReports.length === 0) {
                resultsDiv.innerHTML = '<div class="notification">לא נמצאו דיווחים לחודש שנבחר</div>';
                return;
            }

            // Generate report HTML
            let html = '<h3>דוח חודשי</h3>';
            let totalHours = 0;
            let totalDays = 0;

            const researcherSummary = {};

            monthReports.forEach(report => {
                const reportDate = new Date(report.date);
                html += `<div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">`;
                html += `<h4>${reportDate.getDate()}/${reportDate.getMonth() + 1}/${reportDate.getFullYear()}</h4>`;

                if (report.type === 'daily') {
                    if (report.workStatus === 'no-work') {
                        html += '<p>לא עבד</p>';
                    } else {
                        report.entries.forEach(entry => {
                            html += `<p>${entry.researcher}: ${entry.hours} שעות`;
                            if (entry.detail) html += ` - ${entry.detail}`;
                            html += '</p>';

                            totalHours += entry.hours;

                            if (!researcherSummary[entry.researcher]) {
                                researcherSummary[entry.researcher] = { hours: 0, days: 0 };
                            }
                            researcherSummary[entry.researcher].hours += entry.hours;
                        });
                    }
                } else if (report.type === 'weekly') {
                    report.entries.forEach(entry => {
                        html += `<p>${entry.researcher}: ${entry.days} ימים`;
                        if (entry.detail) html += ` - ${entry.detail}`;
                        html += '</p>';

                        totalDays += entry.days;

                        if (!researcherSummary[entry.researcher]) {
                            researcherSummary[entry.researcher] = { hours: 0, days: 0 };
                        }
                        researcherSummary[entry.researcher].days += entry.days;
                    });
                }

                html += '</div>';
            });

            // Summary
            html += '<div style="margin-top: 30px; padding: 20px; background-color: #f9fafb; border-radius: 5px;">';
            html += '<h3>סיכום חודשי</h3>';
            html += `<p><strong>סה"כ שעות: ${totalHours}</strong></p>`;
            html += `<p><strong>סה"כ ימים: ${totalDays}</strong></p>`;

            html += '<h4>פילוח לפי חוקר/פרויקט:</h4>';
            Object.entries(researcherSummary).forEach(([researcher, summary]) => {
                html += `<p>${researcher}: `;
                if (summary.hours > 0) html += `${summary.hours} שעות`;
                if (summary.days > 0) html += `${summary.days} ימים`;
                html += '</p>';
            });

            html += '</div>';

            resultsDiv.innerHTML = html;
        }

        // Event listeners for toggles
        document.addEventListener('DOMContentLoaded', function() {
            // Report type toggle
            document.querySelectorAll('#report-type-toggle .toggle-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectReportType(this.dataset.type);
                });
            });
            
            // Work status toggle
            document.querySelectorAll('#work-status-toggle .toggle-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectWorkStatus(this.dataset.status);
                });
            });
            
            // Initialize the app
            init();
            
            // Add initial work entry
            setTimeout(() => {
                addWorkEntry();
            }, 100);
        });
    </script>
</body>
</html>