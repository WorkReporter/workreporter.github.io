<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Guided Tour â€” ××¢×¨×›×ª ×“×™×•×•×— ×©×¢×•×ª (×”×“×’××”)</title>
    <style>
        html,body{height:100%;margin:0;font-family:Segoe UI, Arial, sans-serif;background:#f6f9ff}
        .frame-wrap{position:fixed;inset:0;display:flex;flex-direction:column}
        header{background:#0b3b76;color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
        header h1{font-size:16px;margin:0}
        #appFrame{flex:1;border:6px solid rgba(11,59,118,0.08);border-radius:8px;margin:18px;box-shadow:0 8px 30px rgba(2,24,43,0.06)}

        /* ×”×¡×ª×¨×ª ×”×‘×× ×¨ ×‘××¦×‘ ×”×“×¨×›×” - ××•×¡×¨ ×›×“×™ ×©×”×›×•×ª×¨×ª ×ª×™×©××¨ ×’×œ×•×™×” */
        /* .tour-active header{
            display: none;
        } */

        /* ×”×›×•×ª×¨×ª ×‘××¦×‘ ×”×“×¨×›×” - × ×©××¨ ×’×œ×•×™ ××š ×¢× z-index ×’×‘×•×” ×™×•×ª×¨ */
        .tour-active header{
            position: relative;
            z-index: 1000010 !important; /* ×”×’×‘×”×ª z-index ×›×“×™ ×œ×”×™×•×ª ××¢×œ ×”×›×œ */
        }

        .tour-active #appFrame{
            margin: 0;
            border: none;
            border-radius: 0;
            box-shadow: none;
        }

        /* ××™× ×“×™×§×˜×•×¨ ×“×™×¡×§×¨×˜×™ ×œ××¦×‘ ×”×“×¨×›×” - ××™×§×•× ××ª×—×ª ×œ×ª×¤×¨×™×˜ */
        .tour-indicator{
            position: fixed;
            top: 120px; /* ××ª×—×ª ×œ×›×•×ª×¨×ª ×•×”×ª×¤×¨×™×˜ */
            right: 10px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            z-index: 100; /* × ××•×š ×××•×“ ×›×“×™ ×œ×”×™×•×ª ××ª×—×ª ×œ×›×œ ×”UI */
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tour-indicator .close-tour-btn{
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .tour-indicator .close-tour-btn:hover{
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 600px){
            .tour-indicator{
                top: 110px; /* ××•×ª×× ×œ××•×‘×™×™×œ - ××ª×—×ª ×œ×ª×¤×¨×™×˜ */
                right: 5px;
                padding: 6px 12px;
                font-size: 11px;
                z-index: 100;
            }

            .tour-indicator .close-tour-btn{
                padding: 3px 6px;
                font-size: 10px;
            }
        }

        /* overlay - z-index ×’×‘×•×” ×™×•×ª×¨ ××”UI ××‘×œ ×¢× ××¡×’×¨×ª ×›×—×•×œ×” ××¢×œ ×”××œ×× ×˜×™× */
        .tour-overlay{position:fixed;inset:0;pointer-events:none;z-index: 1000008} /* ××¢×œ ×”UI */
        .mask{position:absolute;inset:0;background:rgba(7,17,34,0.6);z-index: 1000008}
        .highlight{
            position:absolute;
            border-radius:10px;
            box-shadow:0 8px 40px rgba(35,118,209,0.35);
            border:3px solid #3b82f6;
            pointer-events:auto;
            transition:all 350ms ease;
            z-index: 1000011; /* ××¢×œ ×”×›×•×ª×¨×ª ×•×”×ª×¤×¨×™×˜ */
            background: rgba(59, 130, 246, 0.1); /* ×¨×§×¢ ×©×§×•×£ ×§×œ */
        }

        .tooltip{
            position:absolute;
            max-width:420px;
            background:linear-gradient(180deg,#fff,#f2f7ff);
            color:#0b2546;
            padding:18px;
            border-radius:12px;
            box-shadow:0 15px 40px rgba(11,59,118,0.25);
            pointer-events:auto;
            transition:all 350ms ease;
            z-index: 1000012; /* ×”×’×‘×•×” ×‘×™×•×ª×¨ */
            border:2px solid rgba(59,130,246,0.3);
            /* ×”×‘×˜×—×” ×©×”×˜×•×œ×˜×™×¤ ×œ× ×™×—×¤×•×£ ×¢×œ ×”×›×•×ª×¨×ª */
            margin-top: 5px;
        }

        .tooltip h3{margin:0 0 6px 0;font-size:15px}
        .tooltip p{margin:0 0 12px 0;font-size:14px;color:#1f2d47;line-height:1.4}
        .tooltip .controls{display:flex;gap:8px;justify-content:flex-end}
        .btn{background:#165ea8;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
        .btn.ghost{background:transparent;color:#cfe0ff;border:1px solid rgba(255,255,255,0.08)}
        .close-link{background:transparent;border:none;color:#cbd5e1;cursor:pointer}
        .arrow{position:absolute;width:28px;height:28px;transform:rotate(45deg);background:#fff;border-radius:4px;box-shadow:0 6px 18px rgba(11,59,118,0.18);z-index:999999}

        .notes{font-size:12px;color:#e6eefc}
        footer{padding:10px 18px;text-align:center;color:#64748b;font-size:13px}

        /* ×¨×¡×¤×•× ×¡×™×‘×™ ×œ××•×‘×™×™×œ */
        @media (max-width:900px){
            .tooltip{
                max-width:min(90vw, 350px);
                padding:16px;
                font-size:13px;
                left:5vw !important;
                right:5vw;
                width:90vw;
                max-width:90vw;
            }
            .tooltip p{font-size:13px}
            .tooltip h3{font-size:14px}
            header h1{font-size:14px}
        }

        @media (max-width:600px){
            .tooltip{
                max-width:min(95vw, 320px);
                padding:14px;
                left:2.5vw !important;
                right:2.5vw;
                width:95vw;
                max-width:95vw;
                bottom:20px !important;
                top:auto !important;
            }
            .tooltip p{font-size:12px}
            .tooltip h3{font-size:13px}
            .tooltip .controls{
                flex-direction:column;
                gap:6px;
            }
            .btn{
                padding:10px 16px;
                font-size:14px;
                width:100%;
            }
            header{padding:10px 12px}
            header h1{font-size:12px}
            #appFrame{margin:10px}

            /* ×‘××•×‘×™×™×œ - ×”×¦×‘ ×˜×•×œ×˜×™×¤ ×‘×ª×—×ª×™×ª ×”××¡×š */
            .arrow{display:none !important}
        }

        @media (max-width:420px){
            .tooltip{
                left:5px !important;
                right:5px;
                width:calc(100vw - 10px);
                max-width:calc(100vw - 10px);
                bottom:10px !important;
                padding:12px;
            }
        }

        /* ×•×™×“×•× ×©×”×˜×•×œ×˜×™×¤ ×ª××™×“ × ×¨××” */
        .tooltip{
            min-height:80px;
            display:flex !important;
            flex-direction:column;
            justify-content:space-between;
        }

        /* ×¡×’× ×•×Ÿ ××™×•×—×“ ×œ×¡×™×•× ×”×˜×•×¨ */
        .tooltip.tour-complete{
            position:fixed !important;
            top:50% !important;
            left:50% !important;
            transform:translate(-50%, -50%) !important;
            max-width:400px;
            width:90vw;
            z-index:1000001 !important;
        }

        @media (max-width:600px){
            .tooltip.tour-complete{
                width:95vw;
                max-width:95vw;
                top:50% !important;
                bottom:auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="frame-wrap">
        <header>
            <h1>Guided Tour â€” ×”×“×’××ª ×”×©×™××•×© ×‘××ª×¨</h1>
            <div>
                <button id="start-tour" class="btn">×”×ª×—×œ ×¡×™×•×¨</button>
                <button id="open-home" class="btn ghost">×¤×ª×— ×“×£ ×‘×™×ª ×œ×—×œ×•×Ÿ</button>
            </div>
        </header>

        <!-- iframe loads the real homepage (relative path) -->
        <iframe id="appFrame" src="homepage.html" title="Homepage"></iframe>

        <!-- ××™× ×“×™×§×˜×•×¨ ×“×™×¡×§×¨×˜×™ ×œ××¦×‘ ×”×“×¨×›×” -->
        <div class="tour-indicator" id="tourIndicator" style="display:none">
            <span>ğŸ¯ ×”×“×’××ª ×”×©×™××•×© ×‘××ª×¨</span>
            <button class="close-tour-btn" id="closeTourIndicator">×¡×’×•×¨</button>
        </div>

        <div class="tour-overlay" id="tourOverlay" aria-hidden="true">
            <div class="mask" id="mask"></div>
            <div class="highlight" id="highlight" style="display:none"></div>
            <div class="arrow" id="arrow" style="display:none"></div>
            <div class="tooltip" id="tooltip" style="display:none" role="dialog" aria-modal="true">
                <h3 id="tip-title"></h3>
                <p id="tip-text"></p>
                <div class="controls">
                    <button class="btn" id="prev-btn" style="display:none">×—×–×•×¨</button>
                    <button class="btn" id="next-btn">×”××©×š</button>
                    <button class="close-link" id="skip-btn">×¡×’×•×¨</button>
                </div>
            </div>
        </div>

        <footer>×¡×™×•×¨ ×–×” ××©×ª××© ×‘-iframe ×©×œ homepage.html ×©× ××¦× ×‘×¡×¤×¨×™×™×ª ×”×¤×¨×•×™×§×˜. ×× ××™× ×š ×¨×•××” ××œ×× ×˜×™× ××¡×•×™××™× - ×•×“× ×©-homepage.html × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”.</footer>
    </div>

    <script>
        (function(){
            // support two modes:
            // - standalone: guided_tour.html loads homepage in an iframe (#appFrame)
            // - embedded: the overlay + script are injected into the host page (no #appFrame present)
            const iframeEl = document.getElementById('appFrame');
            const embeddedMode = !iframeEl; // if injected into another page there is no iframe
            const iframe = iframeEl || null;
            const startBtn = document.getElementById('start-tour');
            const openHome = document.getElementById('open-home');
            const overlay = document.getElementById('tourOverlay');
            const highlight = document.getElementById('highlight');
            const tooltip = document.getElementById('tooltip');
            const arrow = document.getElementById('arrow');
            const tipTitle = document.getElementById('tip-title');
            const tipText = document.getElementById('tip-text');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const skipBtn = document.getElementById('skip-btn');
            const closeTourIndicator = document.getElementById('closeTourIndicator');
            const tourIndicator = document.getElementById('tourIndicator');

            // Steps: selector is searched inside iframe document. action: "click" means click it when advancing.
            const steps = [
                {
                    id: 'main-screen',
                    title: '××¡×š ×¨××©×™ - × ×§×•×“×ª ×”××•×¦×',
                    text: '×–×”×• ×”××¡×š ×”×¨××©×™. ×›××Ÿ ×ª×¨××• ×”×•×“×¢×•×ª ×¢×œ ×“×™×•×•×—×™× ×—×¡×¨×™× (×¢×“ 4 ×‘×©×‘×•×¢), ×•×ª×•×›×œ×• ×œ×”×•×¡×™×£ ×“×™×•×•×— ×—×“×©. ×©×™××• ×œ×‘: ×‘×™××™× ×-×“ ×™×¤×ª×— ×“×™×•×•×— ×™×•××™, ×‘×™×•× ×”\' ×ª×•×›×œ×• ×œ×‘×—×•×¨ ×‘×™×Ÿ ×™×•××™ ×œ×©×‘×•×¢×™.',
                    selector: "#main-screen",
                    action: null
                },
                {
                    id: 'add-report-main',
                    title: '×›×¤×ª×•×¨ ×”×•×¡×¤×ª ×“×™×•×•×—',
                    text: '×œ×—×¦×Ÿ ×–×” ×¤×•×ª×— ×˜×•×¤×¡ ×“×™×•×•×— ×—×“×©. ×”×¡×•×’ ×ª×œ×•×™ ×‘×™×•×: ×\'-×“\' = ×“×™×•×•×— ×™×•××™ ×‘×œ×‘×“, ×™×•× ×”\' = ×‘×—×™×¨×” ×‘×™×Ÿ ×™×•××™ ×œ×©×‘×•×¢×™. ×œ× × ×™×ª×Ÿ ×œ×“×•×•×— ×‘×©×™×©×™-×©×‘×ª.',
                    selector: '#add-report-btn',
                    action: 'click'
                },
                {
                    id: 'daily-report-form',
                    title: '×˜×•×¤×¡ ×“×™×•×•×— ×™×•××™',
                    text: '×“×™×•×•×— ×™×•××™-×©×¢×ª×™: ×‘×—×¨×• ×ª××¨×™×š, ×¢×‘×“×ª×™/×œ× ×¢×‘×“×ª×™. ×× ×¢×‘×“×ª× - ×‘×—×¨×• ×—×•×§×¨ ××”×¨×©×™××” ×•××¡×¤×¨ ×©×¢×•×ª (×©×œ××•×ª ××• ×—×¦××™). × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ××¡×¤×¨ ×©×•×¨×•×ª. ×—×©×•×‘: × ×™×ª×Ÿ ×œ×¢×¨×•×š ×¨×§ ×“×™×•×•×—×™× ××”×©×‘×•×¢ ×”× ×•×›×—×™!',
                    selector: "#work-status-toggle",
                    action: null
                },
                {
                    id: 'reports-nav',
                    title: '××¢×‘×¨ ×œ×“×•×—×•×ª',
                    text: '×›×¢×ª × ×¢×‘×•×¨ ×œ×¢××•×“ ×”×“×•×—×•×ª ×œ×¨××•×ª ××™×š ××¦×™×’×™× ××ª ×”× ×ª×•× ×™× ×©×“×™×•×•×—×ª×.',
                    selector: ".nav-btn[onclick*='reports']",
                    action: 'click'
                },
                {
                    id: 'reports-screen',
                    title: '××¡×š ×“×•×—×•×ª ×—×•×“×©×™×™×',
                    text: '×›××Ÿ ×ª×•×›×œ×• ×œ×¨××•×ª ×“×•×—×•×ª ×œ×¤×™ ×—×•×“×© ×•×©× ×”. ×”× ×ª×•× ×™× ××’×™×¢×™× ××›×œ ×”×“×™×•×•×—×™× ×©×‘×™×¦×¢×ª×. ×”× ×ª×•× ×™× ××‘×•×’×‘×™× ××•×˜×•××˜×™×ª ×œ×’×•×‘×œ ×”×“×¨×™×‘ ×›×œ ×—×•×“×©.',
                    selector: "#report-month",
                    action: null
                },
                {
                    id: 'calendar-nav',
                    title: '××¢×‘×¨ ×œ×™×•××Ÿ',
                    text: '×›×¢×ª × ×¢×‘×•×¨ ×œ×™×•××Ÿ ×œ×¨××•×ª ××¦×‘ ×”×“×™×•×•×—×™× ×©×œ×›× ×‘×¦×•×¨×” ×•×™×–×•××œ×™×ª.',
                    selector: ".nav-btn[onclick*='calendar']",
                    action: 'click'
                },
                {
                    id: 'calendar-screen',
                    title: '××¡×š ×™×•××Ÿ - ××¢×§×‘ ×•×™×–×•××œ×™',
                    text: '×”×™×•××Ÿ ××¦×™×’ ××ª ×”×—×•×“×© ×”× ×•×›×—×™ ×¢× ×¡×™××•×Ÿ ×”×™×•× ×”× ×•×›×—×™ ×•××™× ×“×™×§×¦×™×” ×œ×ª××¨×™×›×™× ×¢× ×“×™×•×•×—×™×. ×”××˜×¨×”: ×›×œ ×”×™××™× ×™×”×™×• ××¡×•×× ×™×! × ×™×ª×Ÿ ×œ×œ×—×•×¥ ×¢×œ ×™×•× ×œ×œ× ×“×™×•×•×— ×›×“×™ ×œ×”×•×¡×™×£ ×“×™×•×•×— ×œ××•×ª×• ×ª××¨×™×š (×¨×§ ×× ×–×” ××”×©×‘×•×¢ ×”× ×•×›×—×™ ××• ×©×‘×•×¢ ×§×•×“×).',
                    selector: "#calendar-grid",
                    action: null
                },
                {
                    id: 'researchers-nav',
                    title: '××¢×‘×¨ ×œ×—×•×§×¨×™× ×¤×¢×™×œ×™×',
                    text: '×›×¢×ª × ×¨××” ××ª ××¡×š × ×™×”×•×œ ×”×—×•×§×¨×™× ×”×¤×¢×™×œ×™×.',
                    selector: ".nav-btn[onclick*='active-researchers']",
                    action: 'click'
                },
                {
                    id: 'active-researchers',
                    title: '×—×•×§×¨×™× ×¤×¢×™×œ×™× - ×”×’×“×¨×ª ×¨×©×™××ª ×”×¢×‘×•×“×”',
                    text: '×›××Ÿ ×ª×’×“×™×¨×• ××ª ×¨×©×™××ª ×”×—×•×§×¨×™× ×©××ª× ×¢×•×‘×“×™× ××™×ª×. ×¨×§ ×”×—×•×§×¨×™× ×”××¡×•×× ×™× ×™×•×¤×™×¢×• ×‘×¨×©×™××” ×‘×¢×ª ×”×“×™×•×•×—. ×‘×¡×•×£ ×”×¨×©×™××” ×ª××™×“ ×™×•×¤×™×¢×• "××©×™××•×ª ××—×¨×•×ª" ×•"×¡××™× ×¨/×§×•×¨×¡/×”×›×©×¨×”" (×œ× × ×™×ª×Ÿ ×œ×©× ×•×ª). ×‘××©×™××•×ª ××œ×• ×ª×•×›×œ×• ×œ×”×•×¡×™×£ ×”×¡×‘×¨ ×‘×˜×§×¡×˜ ×—×•×¤×©×™.',
                    selector: "#researchers-list",
                    action: null
                },
                {
                    id: 'weekly-info',
                    title: '×“×™×•×•×— ×©×‘×•×¢×™ - ××™×“×¢ ×—×©×•×‘',
                    text: '×“×™×•×•×— ×©×‘×•×¢×™ ×–××™×Ÿ ×¨×§ ×‘×™×•× ×—××™×©×™! ×‘×“×™×•×•×— ×©×‘×•×¢×™ ××“×•×•×—×™× ×™××™× (×œ× ×©×¢×•×ª) ×‘×§×¤×™×¦×•×ª ×©×œ 0.25, ××§×¡×™××•× 5 ×™××™×. ×—×©×•×‘: ×× ×™×© ×“×™×•×•×—×™× ×™×•××™×™× ×‘××•×ª×• ×©×‘×•×¢, ×œ× × ×™×ª×Ÿ ×œ×¢×©×•×ª ×“×™×•×•×— ×©×‘×•×¢×™. × ×™×ª×Ÿ ×œ×¢×¨×•×š ×¨×§ ×“×™×•×•×—×™× ××”×©×‘×•×¢ ×”× ×•×›×—×™, ××‘×œ × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×“×™×•×•×— ×—×“×© ×©×‘×•×¢ ××—×•×¨×”.',
                    selector: "#researchers-list",
                    action: null
                },
                {
                    id: 'user-profile-nav',
                    title: '×¤×¨×˜×™ ××©×ª××©',
                    text: '×œ×¡×™×•×, × ×‘×§×¨ ×‘×¤×¨×˜×™ ×”××©×ª××©. ×œ×—×¦×• ×¢×œ ××™×™×§×•×Ÿ ×”××©×ª××© ×‘×¤×™× ×”.',
                    selector: ".user-icon",
                    action: 'click'
                },
                {
                    id: 'user-profile',
                    title: '××¡×š ×¤×¨×˜×™ ××©×ª××©',
                    text: '×›××Ÿ ××•×¤×™×¢×™× ×”×¤×¨×˜×™× ×©×”×•×–× ×• ×‘×”×¨×©××”. × ×™×ª×Ÿ ×œ×¢×¨×•×š ××•×ª× ×‘×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ "×¢×¨×•×š".',
                    selector: "#profile-first-name",
                    action: null
                },
                {
                    id: 'tour-complete',
                    title: '×¡×™×•× ×”×”×“×¨×›×”',
                    text: '××¢×•×œ×”! ×¡×™×™××ª× ××ª ×”×”×“×¨×›×”. ×–×›×¨×•: ×“×•×•×—×• ×‘×–××Ÿ (×¢×“ ×™×•× ×”\'), ×¢×¨×›×• ×¨×§ ×“×™×•×•×—×™× ××”×©×‘×•×¢ ×”× ×•×›×—×™, ×•×”×©×ª××©×• ×‘×™×•××Ÿ ×œ××¢×§×‘ ×•×™×–×•××œ×™. ×‘×”×¦×œ×—×”!',
                    selector: "body",
                    action: null
                }
            ];

            let stepIndex = 0;
            let iframeDoc = null;
            let stepsHistory = []; // Track which screens we visited for proper back navigation

            // helpers
            function ensureIframeDoc(){
                // In embedded mode we operate on the top-level document
                if(embeddedMode){ iframeDoc = document; return true; }
                try{
                    iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    return !!iframeDoc;
                }catch(e){
                    console.warn('Cannot access iframe document (cross-origin?)', e);
                    return false;
                }
            }

            function findInIframe(selector){
                if(!ensureIframeDoc()) return null;
                try{
                    return iframeDoc.querySelector(selector);
                }catch(e){
                    return null;
                }
            }

            function placeOverlayOnElement(el){
                if(!el){ // hide
                    highlight.style.display='none';
                    tooltip.style.display='none';
                    arrow.style.display='none';
                    return;
                }

                const eRect = el.getBoundingClientRect();
                const padding = 10;
                let left, top, width, height, spaceAbove, spaceBelow;

                // ×ª×™×§×•×Ÿ: ×‘××¦×‘ embedded ××™×Ÿ ×¦×•×¨×š ×‘×”×ª×××•×ª × ×•×¡×¤×•×ª
                left = eRect.left - padding;
                top = eRect.top - padding;
                width = eRect.width + padding*2;
                height = eRect.height + padding*2;
                spaceAbove = eRect.top;
                spaceBelow = window.innerHeight - (eRect.top + eRect.height);

                highlight.style.display='block';
                highlight.style.left = left + 'px';
                highlight.style.top = top + 'px';
                highlight.style.width = width + 'px';
                highlight.style.height = height + 'px';

                // Tooltip placement - ×¨×¡×¤×•× ×¡×™×‘×™
                const isMobile = window.innerWidth <= 600;
                tooltip.style.display='block';

                if(isMobile) {
                    // ×‘××•×‘×™×™×œ - ××§× ×‘×ª×—×ª×™×ª ×”××¡×š
                    tooltip.style.left = '2.5vw';
                    tooltip.style.right = '2.5vw';
                    tooltip.style.top = 'auto';
                    tooltip.style.bottom = '20px';
                    tooltip.style.width = '95vw';
                    tooltip.style.maxWidth = '95vw';
                    tooltip.style.transform = 'none';
                    arrow.style.display = 'none';
                } else {
                    // ×“×¡×§×˜×•×¤ - ×”×œ×•×’×™×§×” ×”××ª×•×§× ×ª
                    const tooltipWidth = Math.min(420, window.innerWidth * 0.9);
                    const margin = 12;

                    // Calculate available space on each side
                    const spaceLeft = left;
                    const spaceRight = window.innerWidth - (left + width);

                    if(spaceAbove > 140){ // place above
                        let tl;
                        if(spaceRight >= tooltipWidth + 12){
                            tl = left;
                        } else if(spaceLeft >= tooltipWidth + 12){
                            tl = left + width - tooltipWidth;
                        } else {
                            tl = Math.max(12, Math.min(left + width/2 - tooltipWidth/2, window.innerWidth - tooltipWidth - 12));
                        }
                        tooltip.style.left = tl + 'px';
                        tooltip.style.top = (top - 160 - margin) + 'px'; // ×”×’×“×œ×ª ×”××¨×•×•×— ×œ××¢×œ×”
                        tooltip.style.bottom = 'auto';
                        tooltip.style.maxWidth = tooltipWidth + 'px';
                        tooltip.style.width = 'auto';
                        tooltip.style.transform = 'none';

                        // ××™×§×•× ×”×—×¥
                        arrow.style.left = (left + width/2 - 14) + 'px';
                        arrow.style.top = (top - 6) + 'px';
                        arrow.style.display = 'block';
                    }else{ // place below
                        let tl;
                        if(spaceRight >= tooltipWidth + 12){
                            tl = left;
                        } else if(spaceLeft >= tooltipWidth + 12){
                            tl = left + width - tooltipWidth;
                        } else {
                            tl = Math.max(12, Math.min(left + width/2 - tooltipWidth/2, window.innerWidth - tooltipWidth - 12));
                        }
                        tooltip.style.left = tl + 'px';
                        tooltip.style.top = (top + height + margin) + 'px';
                        tooltip.style.bottom = 'auto';
                        tooltip.style.maxWidth = tooltipWidth + 'px';
                        tooltip.style.width = 'auto';
                        tooltip.style.transform = 'none';

                        // ××™×§×•× ×”×—×¥
                        arrow.style.left = (left + width/2 - 14) + 'px';
                        arrow.style.top = (top + height + margin - 8) + 'px';
                        arrow.style.display = 'block';
                    }
                }
            }

            function showStep(i){
                if(!ensureIframeDoc()){
                    alert('××™×Ÿ ×’×™×©×” ×œ-iframe. ×•×“× ×©-guided_tour.html ×•-homepage.html ×××•×—×¡× ×™× ×‘××•×ª×• ××§×•×¨ (local).');
                    return;
                }
                if(i<0 || i>=steps.length){endTour();return}
                stepIndex = i;
                const s = steps[i];
                tipTitle.textContent = s.title || '';
                tipText.textContent = s.text || '';

                // find element
                let el = findInIframe(s.selector);

                // Debug logging
                console.log('Step:', s.id, 'Selector:', s.selector, 'Found element:', el);
                if(el) {
                    const rect = el.getBoundingClientRect();
                    console.log('Element position:', rect);
                }

                // fallback: try by id if selector was not found
                if(!el && s.selector && s.selector.includes('#')){
                    try{
                        el = iframeDoc.getElementById(s.selector.replace('#',''));
                        console.log('Fallback by ID found:', el);
                    }catch(e){}
                }

                // if not found, attempt to search by text (hebrew) - best-effort
                if(!el && s.title){
                    const text = s.title.trim();
                    const all = iframeDoc.querySelectorAll('button, a, div, span, select, input');
                    for(const node of all){
                        if(node.innerText && node.innerText.includes(text)){
                            el = node;
                            console.log('Found by text search:', el);
                            break;
                        }
                    }
                }

                // Better fallback for navigation buttons
                if(!el && s.selector && s.selector.includes("nav-btn")){
                    // Try to find navigation buttons by their text content
                    const navButtons = iframeDoc.querySelectorAll('.nav-btn');
                    for(const btn of navButtons){
                        const btnText = btn.textContent || btn.innerText;
                        if((s.id === 'reports-nav' && btnText.includes('×“×•×—×•×ª')) ||
                           (s.id === 'calendar-nav' && btnText.includes('×™×•××Ÿ')) ||
                           (s.id === 'researchers-nav' && btnText.includes('×—×•×§×¨×™×'))){
                            el = btn;
                            console.log('Found nav button by text:', el, btnText);
                            break;
                        }
                    }
                }

                // show prev/next buttons
                prevBtn.style.display = (i>0)?'inline-flex':'none';
                nextBtn.textContent = (i===steps.length-1)?'×¡×™×•×':'×”××©×š';

                // Special handling for final step - always center it
                if(s.id === 'tour-complete'){
                    highlight.style.display='none';
                    tooltip.style.display='block';
                    tooltip.classList.add('tour-complete');
                    arrow.style.display='none';
                } else {
                    tooltip.classList.remove('tour-complete');
                    if(el){
                        placeOverlayOnElement(el);
                    }else{
                        console.warn('Element not found for step:', s.id, s.selector);
                        // fallback - show tooltip at center
                        highlight.style.display='none';
                        tooltip.style.display='block';
                        arrow.style.display='none';
                        const isMobile = window.innerWidth <= 600;
                        if(isMobile) {
                            tooltip.style.left = '2.5vw';
                            tooltip.style.top = '20%';
                            tooltip.style.bottom = 'auto';
                            tooltip.style.width = '95vw';
                            tooltip.style.maxWidth = '95vw';
                        } else {
                            tooltip.style.left = (window.innerWidth/2 - 210) + 'px';
                            tooltip.style.top = (120 + i*20) + 'px';
                            tooltip.style.bottom = 'auto';
                            tooltip.style.maxWidth = '420px';
                            tooltip.style.width = 'auto';
                        }
                    }
                }

                // If action is click and we are moving forward, clicking will be executed when pressing next
            }

            function nextStep(){
                const s = steps[stepIndex];
                // Track current screen state before moving forward
                if(s && s.action === 'click'){
                    stepsHistory.push({
                        stepIndex: stepIndex,
                        screenState: getCurrentScreenState()
                    });
                }

                let el = s && ensureIframeDoc() ? findInIframe(s.selector) : null;
                if(s && s.action==='click' && el){
                    try{ el.click(); }catch(e){ console.warn('click failed', e); }
                    // wait a bit for UI to update inside iframe
                    setTimeout(()=> showStep(stepIndex+1), 600);
                    return;
                }
                showStep(stepIndex+1);
            }

            function prevStep(){
                // Navigate back to previous screen state if available
                if(stepsHistory.length > 0){
                    const prevState = stepsHistory.pop();
                    restorePreviousScreenState(prevState);
                    setTimeout(()=> showStep(stepIndex-1), 300);
                } else {
                    showStep(stepIndex-1);
                }
            }

            function getCurrentScreenState(){
                // Detect which screen is currently visible
                if(!ensureIframeDoc()) return 'unknown';
                const screens = ['main-screen', 'daily-report-screen', 'reports-screen', 'calendar-screen', 'active-researchers-screen', 'user-profile-screen'];
                for(const screen of screens){
                    const el = iframeDoc.getElementById(screen);
                    if(el && !el.classList.contains('hidden')){
                        return screen;
                    }
                }
                return 'main-screen'; // default
            }

            function restorePreviousScreenState(state){
                if(!ensureIframeDoc() || !state) return;
                // Try to navigate back to the previous screen
                const targetScreen = state.screenState;
                const screenMap = {
                    'main-screen': "button[onclick*='main']",
                    'reports-screen': "button[onclick*='reports']",
                    'calendar-screen': "button[onclick*='calendar']",
                    'active-researchers-screen': "button[onclick*='active-researchers']",
                    'user-profile-screen': ".user-icon"
                };

                const navSelector = screenMap[targetScreen];
                if(navSelector){
                    const navEl = iframeDoc.querySelector(navSelector);
                    if(navEl){
                        try{ navEl.click(); }catch(e){ console.warn('navigation back failed', e); }
                    }
                }
            }

            function startTour(){
                // ×”×¤×¢×œ×ª ××¦×‘ ×”×“×¨×›×” - ×”×¡×ª×¨×ª ×”×‘×× ×¨ ×•×”×¦×’×ª ×”××™× ×“×™×§×˜×•×¨
                document.body.classList.add('tour-active');
                tourIndicator.style.display = 'flex';
                overlay.style.display='block';
                overlay.setAttribute('aria-hidden','false');
                // make sure iframe has loaded
                if(!ensureIframeDoc()){ alert('×××ª×™×Ÿ ×œ×˜×¢×™× ×ª ×“×£ ×”×‘×™×ª...'); }
                showStep(0);
            }

            function endTour(){
                overlay.style.display='none';
                highlight.style.display='none';
                tooltip.style.display='none';
                arrow.style.display='none';
                tooltip.classList.remove('tour-complete');
                tourIndicator.style.display = 'none';
                // ×”×—×–×¨×ª ×”×ª×¦×•×’×” ×”×¨×’×™×œ×”
                document.body.classList.remove('tour-active');

                // ××—×™×§×” ××œ××” ×©×œ ×”-overlay ×©× ×•×¦×¨ ×‘××¦×‘ embedded
                const guidedTourOverlay = document.getElementById('guided-tour-overlay');
                if(guidedTourOverlay) {
                    guidedTourOverlay.remove();
                }

                // ×× ×–×” ×”×©×œ×‘ ×”××—×¨×•×Ÿ (tour-complete), × ×—×–×•×¨ ×œ×“×£ ×”×‘×™×ª ×”×¨×’×™×œ
                if(stepIndex === steps.length - 1){
                    // ×‘××§×¨×” ×©×œ ××¦×‘ standalone, ×¤×©×•×˜ ××¡×™×¨×™× ××ª ××¦×‘ ×”×”×“×¨×›×”
                    if(!embeddedMode && window.location.pathname.includes('guided_tour.html')){
                        // ××•×¤×¦×™×•× ×œ×™: ××¤×©×¨ ×œ× ×•×•×˜ ×œ×“×£ ×”×‘×™×ª ×”×¨×’×™×œ
                        // window.location.href = 'homepage.html';
                    }
                }
            }

            if(startBtn){
                startBtn.addEventListener('click', startTour);
            } else if(embeddedMode){
                // when injected into the host page there is no start button â€” auto-open the tour
                startTour();
            }

            skipBtn.addEventListener('click', endTour);
            nextBtn.addEventListener('click', ()=>{ if(stepIndex===steps.length-1){ endTour(); } else nextStep(); });
            prevBtn.addEventListener('click', prevStep);
            closeTourIndicator.addEventListener('click', endTour);

            if(openHome){ openHome.addEventListener('click', ()=>{ window.open('homepage.html','_blank'); }); }

            // hide overlay initially (unless embeddedMode where we may auto-open)
            if(!embeddedMode) overlay.style.display='none';

            // Wait for iframe to load and then try to sync some basic styling
            if(iframe) {
                iframe.addEventListener('load', ()=>{
                    try{
                        // small courtesy: scroll iframe to top
                        iframe.contentWindow.scrollTo(0,0);
                    }catch(e){}
                });
            }

            // Accessibility: close tour on ESC
            window.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') endTour(); });

            // Handle window resize for responsive tooltip positioning
            window.addEventListener('resize', ()=>{
                if(overlay.style.display !== 'none') {
                    showStep(stepIndex); // Re-position current step
                }
            });

        })();
     </script>
</body>
</html>