<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×“×™×•×•×— ×©×¢×•×ª - × ×™×”×•×œ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', system-ui, -apple-system, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-icon {
            background: #3b82f6;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #64748b;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen-title {
            font-size: 2rem;
            font-weight: 600;
            color: #1e293b;
            text-align: center;
            margin-bottom: 2rem;
        }

        /* Employee List Screen */
        .employees-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 400px;
            margin: 0 auto;
        }

        .employee-button {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            font-size: 1.1rem;
            font-weight: 500;
            color: #334155;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-family: inherit;
        }

        .employee-button:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        /* Calendar Screen */
        .calendar-container {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            max-width: 500px;
            margin: 0 auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .nav-btn {
            background: #f1f5f9;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            color: #475569;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .month-year {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .calendar {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .calendar th {
            padding: 1rem 0.5rem;
            font-weight: 500;
            color: #64748b;
            font-size: 0.9rem;
        }

        .calendar td {
            padding: 0;
            position: relative;
        }

        .calendar-day {
            width: 100%;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            margin: 2px;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: #f1f5f9;
        }

        .calendar-day.other-month {
            color: #cbd5e0;
            cursor: default;
        }

        .calendar-day.other-month:hover {
            background: transparent;
        }

        .calendar-day.has-reports {
            background: #22c55e;
            color: white;
            position: relative;
        }

        .calendar-day.has-reports:hover {
            background: #16a34a;
        }

        .calendar-day.range-start {
            background: #1e40af;
            color: white;
        }

        .calendar-day.range-end {
            background: #1e40af;
            color: white;
        }

        .calendar-day.in-range {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Weekly report visuals */
        .calendar-day.weekly-day {
            position: relative;
        }
        .calendar-day.weekly-day::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 6px;
            right: 6px;
            border-top: 2px dashed rgba(255,255,255,0.9);
        }
        .calendar-day.other-month.weekly-day::after {
            border-top-color: rgba(31,41,55,0.4);
        }
        .calendar-day.weekly-start::before,
        .calendar-day.weekly-end::before {
            content: '';
            position: absolute;
            top: 1px;
            width: 6px;
            height: 6px;
            border: 2px dashed rgba(255,255,255,0.9);
            border-radius: 50%;
        }
        .calendar-day.weekly-start::before { left: 2px; }
        .calendar-day.weekly-end::before { right: 2px; }
        .calendar-day.other-month.weekly-start::before,
        .calendar-day.other-month.weekly-end::before {
            border-color: rgba(31,41,55,0.4);
        }

        .date-selection-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
            color: #64748b;
            font-size: 0.9rem;
        }

        .date-selection-info.has-selection {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .date-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .date-value {
            font-weight: 600;
            color: #1e293b;
        }

        .generate-report-btn {
            width: 100%;
            padding: 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }

        .generate-report-btn:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .generate-report-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .back-btn {
            width: 100%;
            padding: 0.75rem;
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: #e2e8f0;
        }

        /* Report Screens */
        .report-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .report-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .hours-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-right: 4px solid #3b82f6;
        }

        .hours-item.other-task {
            border-right-color: #f59e0b;
        }

        .hours-item.seminar {
            border-right-color: #10b981;
        }

        .hours-label {
            font-weight: 500;
            color: #374151;
        }

        .hours-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .categorization-item {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .categorization-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.25rem;
        }

        .task-hours {
            color: #b45309;
            font-size: 0.9rem;
        }

        .categorization-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            flex: 2;
        }

        .option-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d97706;
            background: white;
            color: #92400e;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .option-btn:hover {
            background: #fef3c7;
        }

        .option-btn.active {
            background: #d97706;
            color: white;
        }

        /* dropdown arrow visual indicator */
        .option-btn .dropdown-arrow {
            margin-inline-start: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .custom-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d97706;
            border-radius: 8px;
            margin-top: 1rem;
            font-family: inherit;
            background: white;
        }

        /* Final Report */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .stats-table th,
        .stats-table td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
        }

        .stats-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .stats-table td {
            color: #1e293b;
        }

        .percentage-cell {
            text-align: center;
            font-weight: 600;
        }

        /* Show-calculation panel styles */
        .calc-actions { margin: 12px 0 0; text-align: left; }
        .calc-btn { background:#0ea5e9; color:#fff; border:none; border-radius:8px; padding:8px 12px; font-weight:600; cursor:pointer; }
        .calc-btn:hover { background:#0284c7; }
        .calc-panel { margin-top:12px; background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; }
        .calc-section { margin-bottom:16px; }
        .calc-title { font-weight:700; color:#1e293b; margin-bottom:8px; }
        .calc-grid { display:grid; grid-template-columns:1fr; gap:8px; }
        .calc-card { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:12px; }
        .calc-subtitle { color:#0f766e; font-weight:700; margin-bottom:6px; }
        .equation { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; direction:ltr; color:#334155; }
        .eq-line { margin:2px 0; }
        .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
        .chip { background:#e2e8f0; color:#0f172a; border-radius:999px; padding:2px 8px; font-size:12px; }
        .note { color:#64748b; font-size:12px; margin-top:6px; }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            margin: 1rem auto;
            animation: spin 1s linear infinite;
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1rem;
            }

            .categorization-header {
                flex-direction: column;
                align-items: stretch;
            }

            .categorization-options {
                justify-content: flex-start;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .back-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, get, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        // Firebase configuration - Replace with your config
        const firebaseConfig = {
            apiKey: "AIzaSyDpzAnHPl8trZDQwC-G5twRWSwdweko_T8",
            authDomain: "work-report-volcani.firebaseapp.com",
            projectId: "work-report-volcani",
            storageBucket: "work-report-volcani.firebasestorage.app",
            messagingSenderId: "569559789764",
            appId: "1:569559789764:web:d11b9c0e43ff78a66dd991",
            measurementId: "G-M5Z4R1FB40",
            databaseURL: "https://work-report-volcani-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Make Firebase available globally
        window.firebaseApp = { app, auth, db, get, ref, query, orderByChild, equalTo };
    </script>

    <div class="header">
        <div class="header-title">
            <div class="header-icon">ğŸ </div>
            ×©× ×× ×”×œ/×ª
        </div>
        <div class="user-profile">
            <div class="user-avatar">ğŸ‘¤</div>
        </div>
    </div>

    <div class="container">
        <div id="employees-screen" class="screen active">
            <h1 class="screen-title">×¢×•×‘×“×™× ×¤×¢×™×œ×™×</h1>
            <div class="employees-list" id="employees-list">
                <div class="loading">×˜×•×¢×Ÿ ×¨×©×™××ª ×¢×•×‘×“×™×...</div>
            </div>
        </div>

        <div id="calendar-screen" class="screen">
            <h1 class="screen-title" id="calendar-title">×¢×•×‘×“ - ×”×¤×§×ª ×“×•"×—</h1>
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="nav-btn" onclick="previousMonth()">â€¹</button>
                    <div class="month-year" id="month-year">××•×’×•×¡×˜ 2025</div>
                    <button class="nav-btn" onclick="nextMonth()">â€º</button>
                </div>

                <table class="calendar">
                    <thead>
                        <tr>
                            <th>×</th>
                            <th>×‘</th>
                            <th>×’</th>
                            <th>×“</th>
                            <th>×”</th>
                            <th>×•</th>
                            <th>×©</th>
                        </tr>
                    </thead>
                    <tbody id="calendar-body">
                        </tbody>
                </table>

                <div class="date-selection-info" id="date-selection">
                    <div>×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×”</div>
                </div>

                <button class="generate-report-btn" id="generate-report" disabled onclick="generateIntermediateReport()">
                    ×”×¤×§×ª ×“×•"×— ×©×¢×•×ª
                </button>

                <button class="back-btn" onclick="showEmployeesScreen()">×—×–×¨×”</button>
            </div>
        </div>

        <div id="intermediate-screen" class="screen">
            <div class="report-container">
                <h1 class="screen-title" id="intermediate-title">×¢×•×‘×“ - ×”×¤×§×ª ×“×•"×— ×©×›×¨ ×‘×™× ×™×™×</h1>
                <p style="text-align: center; color: #64748b; margin-bottom: 2rem;" id="intermediate-subtitle">×œ×ª×§×•×¤×”</p>

                <div id="intermediate-content">
                    <div class="loading">××¢×‘×“ × ×ª×•× ×™ ×“×™×•×•×—...</div>
                </div>

                <div class="action-buttons" id="intermediate-actions" style="display: none;">
                    <button class="generate-report-btn" onclick="generateFinalReport()">
                        ××™×©×•×¨ ×©×¢×•×ª ×“×•"×—
                    </button>
                    <button class="back-btn" onclick="showCalendarScreen()">×—×–×¨×”</button>
                </div>
            </div>
        </div>

        <div id="final-screen" class="screen">
            <div class="report-container">
                <h1 class="screen-title" id="final-title">×¢×•×‘×“ - ×“×•"×—</h1>
                <p style="text-align: center; color: #64748b; margin-bottom: 2rem;" id="final-subtitle">×œ×ª×§×•×¤×”</p>

                <div id="final-content">
                    <div class="loading">××›×™×Ÿ ×“×•"×— ×¡×•×¤×™...</div>
                </div>

                <div class="action-buttons" id="final-actions" style="display: none;">
                    <button class="generate-report-btn" onclick="exportFinalReport()">
                        ×”×¤×§×ª ×“×•"×—
                    </button>
                    <button class="back-btn" onclick="showIntermediateScreen()">×—×–×¨×”</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state management
        const AppState = {
            currentUser: null,
            isManager: false,
            managerName: '',
            employees: [],
            selectedEmployee: null,
            selectedStartDate: null,
            selectedEndDate: null,
            currentMonth: new Date().getMonth(), // Current month
            currentYear: new Date().getFullYear(), // Current year
            reportData: null,
            categorizations: new Map(),
            finalReport: null
        };

        // Firebase data functions - Updated to work with your database structure
        async function loadEmployeesForManager(managerName) {
            try {
                const { db, ref, get } = window.firebaseApp;
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);

                if (!snapshot.exists()) {
                    console.log('No users found');
                    return [];
                }

                const employees = [];
                const data = snapshot.val();

                Object.entries(data).forEach(([userId, userData]) => {
                    // Check if this user has the current manager as their manager
                    // Now compare by manager's full name and email combined
                    if (userData.my_manager && userData.firstName && userData.lastName) {
                        // Extract manager info from stored value (format: "Name|email")
                        const storedManagerInfo = userData.my_manager;

                        // Check if the stored manager matches current manager
                        if (storedManagerInfo.includes(managerName) ||
                            storedManagerInfo.includes(AppState.currentUser?.email || '')) {
                            employees.push({
                                id: userId,
                                ...userData
                            });
                        }
                    }
                });

                console.log(`Found ${employees.length} employees for manager: ${managerName}`);
                return employees;
            } catch (error) {
                console.error('Error loading employees:', error);
                return [];
            }
        }

        function normalizeEntries(entries) {
            if (Array.isArray(entries)) return entries.filter(e => e != null);
            if (entries && typeof entries === 'object') return Object.values(entries).filter(e => e != null);
            return [];
        }

        async function loadEmployeeReports(employeeId, startDate, endDate) {
            try {
                const { db, ref, get } = window.firebaseApp;
                const reportsRef = ref(db, `reports/${employeeId}`);
                const snapshot = await get(reportsRef);

                if (!snapshot.exists()) {
                    return [];
                }

                const reports = [];
                const data = snapshot.val();

                // Normalize start/end to local date-only (midnight) to avoid timezone issues
                const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

                Object.entries(data).forEach(([reportId, reportData]) => {
                    const reportDateObj = new Date(reportData.date);
                    const reportDateOnly = new Date(reportDateObj.getFullYear(), reportDateObj.getMonth(), reportDateObj.getDate());

                    let include = false;
                    if (reportData.type === 'weekly') {
                        const weekStart = getSundayOfWeek(reportDateOnly);
                        const weekEndThu = new Date(weekStart);
                        weekEndThu.setDate(weekStart.getDate() + 4); // Sun-Thu
                        // overlap test
                        include = weekEndThu >= start && weekStart <= end;
                    } else {
                        include = reportDateOnly >= start && reportDateOnly <= end;
                    }

                    if (include) {
                        reports.push({
                            id: reportId,
                            date: `${reportDateOnly.getFullYear()}-${String(reportDateOnly.getMonth()+1).padStart(2,'0')}-${String(reportDateOnly.getDate()).padStart(2,'0')}`,
                            type: reportData.type,
                            entries: normalizeEntries(reportData.entries),
                            workStatus: reportData.workStatus
                        });
                    }
                });

                return reports.sort((a, b) => new Date(a.date) - new Date(b.date));
            } catch (error) {
                console.error('Error loading reports:', error);
                return [];
            }
        }

        async function getReportDatesForEmployee(employeeId, year, month) {
            try {
                const { db, ref, get } = window.firebaseApp;
                const reportsRef = ref(db, `reports/${employeeId}`);
                const snapshot = await get(reportsRef);

                if (!snapshot.exists()) {
                    return { reportedDays: new Set(), weeklyDays: new Set() };
                }

                const reportedDays = new Set();
                const weeklyDays = new Set();
                const data = snapshot.val();

                Object.values(data).forEach(report => {
                    const dateStr = typeof report.date === 'string' ? report.date.split('T')[0] : null;
                    if (!dateStr) return;
                    const [y, m, d] = dateStr.split('-').map(Number);
                    const reportDate = new Date(y, m - 1, d);

                    if (report.type === 'weekly') {
                        const weekStart = getSundayOfWeek(reportDate);
                        for (let i = 0; i <= 4; i++) { // Sun-Thu as working days
                            const cur = new Date(weekStart);
                            cur.setDate(weekStart.getDate() + i);
                            if (cur.getFullYear() === year && cur.getMonth() === month) {
                                reportedDays.add(cur.getDate());
                                weeklyDays.add(cur.getDate());
                            }
                        }
                    } else {
                        if (reportDate.getFullYear() === year && reportDate.getMonth() === month) {
                            reportedDays.add(reportDate.getDate());
                        }
                    }
                });

                return { reportedDays, weeklyDays };
            } catch (error) {
                console.error('Error getting report dates:', error);
                return { reportedDays: new Set(), weeklyDays: new Set() };
            }
        }

        // Screen management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showEmployeesScreen() {
            showScreen('employees-screen');
        }

        function showCalendarScreen(employee) {
            if (employee) {
                AppState.selectedEmployee = employee;
                document.getElementById('calendar-title').textContent = `${employee.firstName} ${employee.lastName} - ×”×¤×§×ª ×“×•"×—`;
            }

            AppState.selectedStartDate = null;
            AppState.selectedEndDate = null;
            updateDateSelection();
            updateGenerateButton();

            showScreen('calendar-screen');
            generateCalendar();
        }


        function showIntermediateScreen() {
            const employee = AppState.selectedEmployee;
            const startDate = AppState.selectedStartDate.toLocaleDateString('he-IL');
            const endDate = AppState.selectedEndDate.toLocaleDateString('he-IL');

            document.getElementById('intermediate-title').textContent = `${employee.firstName} ${employee.lastName} - ×”×¤×§×ª ×“×•"×— ×©×›×¨ ×‘×™× ×™×™×`;
            document.getElementById('intermediate-subtitle').textContent = `×œ×ª×§×•×¤×” ${startDate} - ${endDate}`;

            showScreen('intermediate-screen');
        }

        function showFinalScreen() {
            const employee = AppState.selectedEmployee;
            const startDate = AppState.selectedStartDate.toLocaleDateString('he-IL');
            const endDate = AppState.selectedEndDate.toLocaleDateString('he-IL');

            document.getElementById('final-title').textContent = `${employee.firstName} ${employee.lastName} - ×“×•"×—`;
            document.getElementById('final-subtitle').textContent = `×œ×ª×§×•×¤×” ${startDate} - ${endDate}`;

            showScreen('final-screen');
        }

        // Employee list rendering
        async function renderEmployeesList() {
            const container = document.getElementById('employees-list');

            if (!AppState.currentUser || !AppState.isManager) {
                container.innerHTML = '<div class="empty-state">×™×© ×œ×”×ª×—×‘×¨ ×›×× ×”×œ/×ª ×›×“×™ ×œ×¦×¤×•×ª ×‘×¨×©×™××ª ×”×¢×•×‘×“×™×</div>';
                return;
            }

            try {
                const employees = await loadEmployeesForManager(AppState.managerName);
                AppState.employees = employees;

                if (employees.length === 0) {
                    container.innerHTML = '<div class="empty-state">×œ× × ××¦××• ×¢×•×‘×“×™× ×”××©×•×™×›×™× ××œ×™×š</div>';
                    return;
                }

                const employeeButtons = employees.map(employee => `
                    <button class="employee-button" onclick="showCalendarScreen(${JSON.stringify(employee).replace(/"/g, '&quot;')})">
                        ${employee.firstName} ${employee.lastName}
                    </button>
                `).join('');

                container.innerHTML = employeeButtons;
            } catch (error) {
                console.error('Error rendering employees:', error);
                container.innerHTML = '<div class="empty-state">×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”×¢×•×‘×“×™×</div>';
            }
        }

        // Calendar functions
        async function generateCalendar() {
            const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™',
                              '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];

            document.getElementById('month-year').textContent = `${monthNames[AppState.currentMonth]} ${AppState.currentYear}`;

            const firstDay = new Date(AppState.currentYear, AppState.currentMonth, 1).getDay();
            const daysInMonth = new Date(AppState.currentYear, AppState.currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(AppState.currentYear, AppState.currentMonth, 0).getDate();

            const calendarBody = document.getElementById('calendar-body');
            calendarBody.innerHTML = '';

            let reportMeta = { reportedDays: new Set(), weeklyDays: new Set() };
            if (AppState.selectedEmployee) {
                reportMeta = await getReportDatesForEmployee(
                    AppState.selectedEmployee.id,
                    AppState.currentYear,
                    AppState.currentMonth
                );
            }

            let date = 1;
            let nextMonthDate = 1;

            for (let week = 0; week < 6; week++) {
                const row = document.createElement('tr');

                for (let day = 0; day < 7; day++) {
                    const cell = document.createElement('td');
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';

                    if (week === 0 && day < firstDay) {
                        const prevDate = daysInPrevMonth - firstDay + day + 1;
                        dayDiv.textContent = prevDate;
                        dayDiv.classList.add('other-month');
                    } else if (date > daysInMonth) {
                        dayDiv.textContent = nextMonthDate;
                        dayDiv.classList.add('other-month');
                        nextMonthDate++;
                    } else {
                        dayDiv.textContent = date;

                        if (reportMeta.reportedDays.has(date)) {
                             dayDiv.classList.add('has-reports');
                         }
                        if (reportMeta.weeklyDays.has(date)) {
                            dayDiv.classList.add('weekly-day');
                            const dow = new Date(AppState.currentYear, AppState.currentMonth, date).getDay();
                            if (dow === 0) dayDiv.classList.add('weekly-start');
                            if (dow === 4) dayDiv.classList.add('weekly-end');
                        }

                        const dayNumber = date;
                        dayDiv.addEventListener('click', () => selectDate(dayNumber));
                        date++;
                    }

                    cell.appendChild(dayDiv);
                    row.appendChild(cell);
                }

                calendarBody.appendChild(row);
                if (date > daysInMonth && week > 3) break;
            }

            updateCalendarSelection();
        }

        function selectDate(day) {
            const clickedDate = new Date(AppState.currentYear, AppState.currentMonth, day);

            if (!AppState.selectedStartDate || (AppState.selectedStartDate && AppState.selectedEndDate)) {
                AppState.selectedStartDate = clickedDate;
                AppState.selectedEndDate = null;
            } else if (clickedDate >= AppState.selectedStartDate) {
                AppState.selectedEndDate = clickedDate;
            } else {
                AppState.selectedStartDate = clickedDate;
                AppState.selectedEndDate = null;
            }

            updateCalendarSelection();
            updateDateSelection();
            updateGenerateButton();
        }

        function updateCalendarSelection() {
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('range-start', 'range-end', 'in-range');

                if (!day.classList.contains('other-month')) {
                    const dayNum = parseInt(day.textContent);
                    const dayDate = new Date(AppState.currentYear, AppState.currentMonth, dayNum);

                    if (AppState.selectedStartDate && dayDate.getTime() === AppState.selectedStartDate.getTime()) {
                        day.classList.add('range-start');
                    } else if (AppState.selectedEndDate && dayDate.getTime() === AppState.selectedEndDate.getTime()) {
                        day.classList.add('range-end');
                    } else if (AppState.selectedStartDate && AppState.selectedEndDate &&
                              dayDate > AppState.selectedStartDate && dayDate < AppState.selectedEndDate) {
                        day.classList.add('in-range');
                    }
                }
            });
        }

        function updateDateSelection() {
            const container = document.getElementById('date-selection');

            if (AppState.selectedStartDate && AppState.selectedEndDate) {
                const startStr = AppState.selectedStartDate.toLocaleDateString('he-IL');
                const endStr = AppState.selectedEndDate.toLocaleDateString('he-IL');
                container.className = 'date-selection-info has-selection';
                container.innerHTML = `
                    <div class="date-label">×˜×•×•×— × ×‘×—×¨</div>
                    <div class="date-value">${startStr} - ${endStr}</div>
                `;
            } else if (AppState.selectedStartDate) {
                const startStr = AppState.selectedStartDate.toLocaleDateString('he-IL');
                container.className = 'date-selection-info has-selection';
                container.innerHTML = `
                    <div class="date-label">×ª××¨×™×š ×”×ª×—×œ×”</div>
                    <div class="date-value">${startStr}</div>
                    <div style="margin-top: 0.5rem; font-size: 0.8rem;">×‘×—×¨ ×ª××¨×™×š ×¡×™×•×</div>
                `;
            } else {
                container.className = 'date-selection-info';
                container.innerHTML = '<div>×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×”</div>';
            }
        }

        function updateGenerateButton() {
            const btn = document.getElementById('generate-report');
            btn.disabled = !(AppState.selectedStartDate && AppState.selectedEndDate);
        }

        function previousMonth() {
            if (AppState.currentMonth === 0) {
                AppState.currentMonth = 11;
                AppState.currentYear--;
            } else {
                AppState.currentMonth--;
            }
            generateCalendar();
        }

        function nextMonth() {
            if (AppState.currentMonth === 11) {
                AppState.currentMonth = 0;
                AppState.currentYear++;
            } else {
                AppState.currentMonth++;
            }
            generateCalendar();
        }

        // Report generation functions
        async function generateIntermediateReport() {
            showIntermediateScreen();

            try {
                const reports = await loadEmployeeReports(
                    AppState.selectedEmployee.id,
                    AppState.selectedStartDate,
                    AppState.selectedEndDate
                );

                AppState.reportData = processReportData(reports);
                renderIntermediateReport(AppState.reportData);

            } catch (error) {
                console.error('Error generating report:', error);
                document.getElementById('intermediate-content').innerHTML =
                    '<div class="empty-state">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×“×™×•×•×—</div>';
            }
        }

        // ==========================================================
        // ===== ğŸš€ START: MODIFIED CODE FOR SEMINAR HANDLING ğŸš€ =====
        // ==========================================================

        function processReportData(reports) {
            // ×©×™× ×•×™: ×”×¤×¨×“×” ×œ××¢×¨×›×™× × ×¤×¨×“×™×
            const data = {
                researchers: new Map(),
                otherTasks: [], // ××©×™××•×ª × ×•×¡×¤×•×ª ×‘×œ×‘×“
                seminars: [], // ×¡××™× ×¨×™×/×§×•×¨×¡×™×/×”×›×©×¨×•×ª ×‘×œ×‘×“
                totalHours: 0,
                workDays: new Set(),
                missingDays: []
            };

            reports.forEach(report => {
                const baseDate = new Date(report.date);
                if (report.type === 'weekly') {
                    const weekStart = getSundayOfWeek(baseDate);
                    for (let i = 0; i <= 4; i++) { // Sun-Thu
                        const cur = new Date(weekStart);
                        cur.setDate(weekStart.getDate() + i);
                        data.workDays.add(toLocalDateStr(cur));
                    }
                } else {
                    data.workDays.add(toLocalDateStr(baseDate));
                }

                report.entries.forEach(entry => {
                    let hours = 0;
                    if (report.type === 'weekly') {
                        if (entry && entry.hours != null && entry.hours !== '') {
                            hours = parseFloat(entry.hours) || 0;
                        } else if (entry && entry.days != null && entry.days !== '') {
                            hours = (parseFloat(entry.days) || 0) * 8;
                        } else if (Array.isArray(entry.dailyHours)) {
                            hours = entry.dailyHours.reduce((sum, h) => sum + (parseFloat(h) || 0), 0);
                        } else {
                            hours = 0;
                        }
                    } else {
                        hours = parseFloat(entry.hours) || 0;
                    }

                    data.totalHours += hours;

                    // ×©×™× ×•×™: ×”×¤×¨×“×” ×‘×¨×•×¨×” ×‘×™×Ÿ ×¡××™× ×¨×™× ×œ××©×™××•×ª ××—×¨×•×ª
                    const isSeminar = entry.researcher?.includes('×¡××™× ×¨') ||
                                      entry.researcher?.includes('×§×•×¨×¡') ||
                                      entry.researcher?.includes('×”×›×©×¨×”');

                    if (isSeminar) {
                        data.seminars.push({
                            name: entry.detail || entry.researcher || '×¡××™× ×¨ ×œ× ××•×’×“×¨',
                            hours: hours,
                            date: report.date,
                            categorization: null
                        });
                    } else if (entry.researcher === '××©×™××•×ª ××—×¨×•×ª') {
                        data.otherTasks.push({
                            name: entry.detail || entry.researcher || '××©×™××” ×œ× ××•×’×“×¨×ª',
                            hours: hours,
                            date: report.date,
                            categorization: null
                        });
                    } else {
                        const current = data.researchers.get(entry.researcher) || 0;
                        data.researchers.set(entry.researcher, +(current + hours).toFixed(2));
                    }
                });
            });

            data.missingDays = calculateMissingDays(
                AppState.selectedStartDate,
                AppState.selectedEndDate,
                data.workDays
            );

            return data;
        }

        function calculateMissingDays(startDate, endDate, workDays) {
            const missing = [];
            const current = new Date(startDate);

            while (current <= endDate) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek !== 5 && dayOfWeek !== 6) {
                    const dateStr = `${current.getFullYear()}-${String(current.getMonth()+1).padStart(2,'0')}-${String(current.getDate()).padStart(2,'0')}`;
                    if (!workDays.has(dateStr)) {
                        missing.push(new Date(current));
                    }
                }
                current.setDate(current.getDate() + 1);
            }

            return missing;
        }

        function renderIntermediateReport(data) {
            let html = '';

            // Researchers section (×œ×œ× ×©×™× ×•×™)
            if (data.researchers.size > 0) {
                html += `<div class="report-section"><h3 class="section-title">×—×•×§×¨×™×:</h3>`;
                data.researchers.forEach((hours, researcher) => {
                    html += `
                        <div class="hours-item">
                            <span class="hours-label">${researcher} - ×¡×”"×› ×©×¢×•×ª</span>
                            <span class="hours-value">${hours}</span>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // ×”×¤×¨×“×”: ××©×™××•×ª × ×•×¡×¤×•×ª
            if (data.otherTasks.length > 0) {
                html += `<div class="report-section"><h3 class="section-title">××©×™××•×ª × ×•×¡×¤×•×ª:</h3>`;

                data.otherTasks.forEach((task, index) => {
                    const key = `other_${index}`;

                    html += `
                        <div class="categorization-item">
                            <div class="categorization-header">
                                <div class="task-info">
                                    <div class="task-name">${task.name}</div>
                                    <div class="task-hours">×¡×”"×› ×©×¢×•×ª: ${task.hours}</div>
                                </div>
                                <div class="categorization-options">
                                    <button class="option-btn" onclick="selectCategorization('${key}', 'seminar', this)">×¡××™× ×¨</button>
                                    <button class="option-btn" onclick="selectCategorization('${key}', 'active', this)">×—×•×§×¨ ×¤×¢×™×œ <span class="dropdown-arrow">â–¾</span></button>
                                    <button class="option-btn" onclick="selectCategorization('${key}', 'relative', this)">×—×œ×•×§×” ×™×—×¡×™×ª</button>
                                    <button class="option-btn" onclick="selectCategorization('${key}', 'custom', this)">×—×™×•×‘ ×—×“×©</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // ×”×¤×¨×“×”: ×¡××™× ×¨×™×/×§×•×¨×¡×™×/×”×›×©×¨×•×ª
            if (data.seminars.length > 0) {
                html += `<div class="report-section"><h3 class="section-title">×¡××™× ×¨/×§×•×¨×¡/×”×›×©×¨×”:</h3>`;

                data.seminars.forEach((task, index) => {
                    const key = `sem_${index}`;

                    html += `
                        <div class="categorization-item">
                            <div class="categorization-header">
                                <div class="task-info">
                                    <div class="task-name">${task.name}</div>
                                    <div class="task-hours">×¡×”"×› ×©×¢×•×ª: ${task.hours}</div>
                                </div>
                                <div class="categorization-options">
                                    <button class="option-btn" onclick="selectCategorization('${key}', 'seminar', this)">×¡××™× ×¨</button>
                                    <button class="option-btn" onclick="selectCategorization('${key}', 'active', this)">×—×•×§×¨ ×¤×¢×™×œ <span class="dropdown-arrow">â–¾</span></button>
                                    <button class="option-btn" onclick="selectCategorization('${key}', 'equal', this)">×—×œ×•×§×” ×©×•×•×”</button>
                                    <button class="option-btn" onclick="selectCategorization('${key}', 'custom', this)">×—×™×•×‘ ×—×“×©</button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            if (!html) {
                html = '<div class="empty-state">×œ× × ××¦××• ×“×™×•×•×—×™× ×œ×ª×§×•×¤×” ×”× ×‘×—×¨×ª</div>';
            }

            document.getElementById('intermediate-content').innerHTML = html;
            document.getElementById('intermediate-actions').style.display = 'flex';
        }

        function selectCategorization(taskIndex, type, button) {
            const siblings = button.parentElement.querySelectorAll('.option-btn');
            siblings.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            AppState.categorizations.set(taskIndex, type);

            const item = button.closest('.categorization-item');
            let input = item.querySelector('.custom-input');
            let activeSelect = item.querySelector('.active-select');

            if (input) input.style.display = 'none';
            if (activeSelect) activeSelect.style.display = 'none';

            if (type === 'custom') {
                if (!input) {
                    input = document.createElement('input');
                    input.className = 'custom-input';
                    input.placeholder = '×”×›× ×¡ ×”×¡×‘×¨ ×œ×—×™×•×‘ ×—×“×©...';
                    input.addEventListener('input', (e) => {
                        AppState.categorizations.set(`${taskIndex}_custom`, e.target.value);
                    });
                    item.appendChild(input);
                }
                input.style.display = 'block';
                input.focus();
            } else if (type === 'active') {
                const activeList = (AppState.selectedEmployee && Array.isArray(AppState.selectedEmployee.activeResearchers)) ? AppState.selectedEmployee.activeResearchers : [];
                if (activeList.length > 0) {
                    if (!activeSelect) {
                        activeSelect = document.createElement('select');
                        activeSelect.className = 'active-select custom-input';
                        activeSelect.style.marginTop = '0.5rem';
                        activeSelect.innerHTML = '<option value="">×‘×—×¨ ×—×•×§×¨ ×¤×¢×™×œ...</option>' + activeList.map(r => `<option value="${r}">${r}</option>`).join('');
                        activeSelect.addEventListener('change', (e) => {
                            AppState.categorizations.set(`${taskIndex}_activeResearcher`, e.target.value);
                        });
                        item.appendChild(activeSelect);
                    }
                    activeSelect.style.display = 'block';
                }
            }
        }

        async function generateFinalReport() {
            showFinalScreen();

            try {
                const finalData = processFinalReport(AppState.reportData, AppState.categorizations);
                AppState.finalReport = finalData;
                renderFinalReport(finalData);

            } catch (error) {
                console.error('Error generating final report:', error);
                document.getElementById('final-content').innerHTML =
                    '<div class="empty-state">×©×’×™××” ×‘×”×›× ×ª ×”×“×•"×— ×”×¡×•×¤×™</div>';
            }
        }

        function processFinalReport(data, categorizations) {
            const finalData = {
                categories: new Map(),
                totalHours: data.totalHours,
                categorizedTasks: [],
                missingDays: data.missingDays,
                calculation: { relative: [] }
            };

            data.researchers.forEach((hours, researcher) => {
                finalData.categories.set(researcher, hours);
            });

            const activeList = (AppState.selectedEmployee && Array.isArray(AppState.selectedEmployee.activeResearchers)) ? AppState.selectedEmployee.activeResearchers : [];

            // ×¢×™×‘×•×“ ××©×™××•×ª × ×•×¡×¤×•×ª
            data.otherTasks.forEach((task, index) => {
                const key = `other_${index}`;
                const categorization = categorizations.get(key);
                const customText = categorizations.get(`${key}_custom`);
                const chosenActive = categorizations.get(`${key}_activeResearcher`);
                let categoryName = '×œ× ××§×•×˜×œ×’';
                let displayName = categorization;

                switch (categorization) {
                    case 'active':
                        if (chosenActive) {
                            const prev = finalData.categories.get(chosenActive) || 0;
                            finalData.categories.set(chosenActive, prev + task.hours);
                            categoryName = chosenActive;
                            displayName = `×—×•×§×¨ ×¤×¢×™×œ: ${chosenActive}`;
                        } else if (activeList.length === 1) {
                            const onlyR = activeList[0];
                            const prev = finalData.categories.get(onlyR) || 0;
                            finalData.categories.set(onlyR, prev + task.hours);
                            categoryName = onlyR;
                            displayName = `×—×•×§×¨ ×¤×¢×™×œ: ${onlyR}`;
                        } else {
                            categoryName = '×—×•×§×¨ ×¤×¢×™×œ (×œ× × ×‘×—×¨)';
                            const prev = finalData.categories.get(categoryName) || 0;
                            finalData.categories.set(categoryName, prev + task.hours);
                            displayName = '×—×•×§×¨ ×¤×¢×™×œ (×œ× × ×‘×—×¨)';
                        }
                        break;

                    case 'equal':
                        if (activeList.length > 0) {
                            const portion = task.hours / activeList.length;
                            let remaining = task.hours;

                            activeList.forEach((researcher, idx) => {
                                const amountToAdd = (idx === activeList.length - 1) ? +remaining.toFixed(2) : +portion.toFixed(2);
                                remaining = +(remaining - amountToAdd).toFixed(2);

                                const prevHours = finalData.categories.get(researcher) || 0;
                                finalData.categories.set(researcher, +(prevHours + amountToAdd).toFixed(2));
                            });

                            categoryName = `×—×œ×•×§×” ×©×•×•×” (${activeList.length} ×—×•×§×¨×™×)`;
                            displayName = `×—×œ×•×§×” ×©×•×•×” (${activeList.length} ×—×•×§×¨×™×)`;
                        } else {
                            categoryName = '×—×œ×•×§×” ×©×•×•×” (××™×Ÿ ×—×•×§×¨×™× ×¤×¢×™×œ×™×)';
                            const prev = finalData.categories.get(categoryName) || 0;
                            finalData.categories.set(categoryName, prev + task.hours);
                            displayName = '×—×œ×•×§×” ×©×•×•×” (××™×Ÿ ×—×•×§×¨×™× ×¤×¢×™×œ×™× ×œ×”×§×¦×•×ª)';
                        }
                        break;

                    case 'relative':
                        if (activeList.length > 0) {
                            const weights = activeList.map(r => ({ name: r, base: data.researchers.get(r) || 0 }));
                            const totalBase = weights.reduce((s, w) => s + w.base, 0);

                            if (totalBase > 0) {
                                const detail = { type:'relative', method:'proportional', taskName: task.name, taskHours: +task.hours, totalBase: +totalBase.toFixed(2), items: [] };
                                let remaining = task.hours;
                                weights.forEach((w, idx) => {
                                    const raw = task.hours * (w.base / totalBase);
                                    const add = (idx === weights.length - 1) ? remaining : +raw.toFixed(2);
                                    remaining = +(remaining - add).toFixed(2);
                                    const prev = finalData.categories.get(w.name) || 0;
                                    finalData.categories.set(w.name, +(prev + add).toFixed(2));
                                    detail.items.push({ researcher: w.name, baseHours: +(+w.base).toFixed(2), weight: +((w.base/totalBase)).toFixed(4), allocated: +(+add).toFixed(2) });
                                });
                                finalData.calculation.relative.push(detail);
                                categoryName = '×—×œ×•×§×” ×™×—×¡×™×ª';
                                displayName = `×—×œ×•×§×” ×™×—×¡×™×ª ×œ×¤×™ ×©×¢×•×ª ×¤×¢×™×œ×•×ª (${totalBase.toFixed(2)} ×©"×¢ ×‘×¡×™×¡)`;
                            } else {
                                const portion = task.hours / activeList.length;
                                const detail = { type:'relative', method:'equal', taskName: task.name, taskHours: +task.hours, totalBase: 0, items: [] };
                                let remaining = task.hours;
                                activeList.forEach((r, idx) => {
                                    const add = (idx === activeList.length - 1) ? +remaining.toFixed(2) : +portion.toFixed(2);
                                    remaining = +(remaining - add).toFixed(2);
                                    const prev = finalData.categories.get(r) || 0;
                                    finalData.categories.set(r, +(prev + add).toFixed(2));
                                    detail.items.push({ researcher: r, baseHours: 0, weight: +(1/activeList.length).toFixed(4), allocated: +add.toFixed(2) });
                                });
                                finalData.calculation.relative.push(detail);
                                categoryName = '×—×œ×•×§×” ×™×—×¡×™×ª (×©×•×•×” ×‘×”×¢×“×¨ ×‘×¡×™×¡)';
                                displayName = '×—×œ×•×§×” ×™×—×¡×™×ª (××™×Ÿ ×©×¢×•×ª ×‘×¡×™×¡)';
                            }
                        } else {
                            categoryName = '×—×œ×•×§×” ×™×—×¡×™×ª (×œ×œ× ×—×•×§×¨×™×)';
                            const prev = finalData.categories.get(categoryName) || 0;
                            finalData.categories.set(categoryName, prev + task.hours);
                            displayName = '×—×œ×•×§×” ×™×—×¡×™×ª (××™×Ÿ ×—×•×§×¨×™× ×¤×¢×™×œ×™× ×œ×”×§×¦×•×ª)';
                        }
                        break;
                    case 'seminar':
                        const prevSem = finalData.categories.get('×¡××™× ×¨') || 0;
                        finalData.categories.set('×¡××™× ×¨', prevSem + task.hours);
                        categoryName = '×¡××™× ×¨';
                        displayName = '×¡××™× ×¨';
                        break;
                    case 'custom':
                        // ×©×™× ×•×™: ×”×¦×’×ª "×—×™×•×‘ ×—×“×© - {×”×˜×§×¡×˜}"
                        categoryName = customText ? `×—×™×•×‘ ×—×“×© - ${customText}` : '×—×™×•×‘ ×—×“×©';
                        const prevCustom = finalData.categories.get(categoryName) || 0;
                        finalData.categories.set(categoryName, prevCustom + task.hours);
                        displayName = categoryName;
                        break;
                    default:
                        const prevUn = finalData.categories.get('×œ× ××§×•×˜×œ×’') || 0;
                        finalData.categories.set('×œ× ××§×•×˜×œ×’', prevUn + task.hours);
                        categoryName = '×œ× ××§×•×˜×œ×’';
                        displayName = '×œ× ××§×•×˜×œ×’';
                }

                finalData.categorizedTasks.push({ name: task.name, category: displayName, hours: task.hours });
            });

            // ×¢×™×‘×•×“ ×¡××™× ×¨×™×
            data.seminars.forEach((task, index) => {
                const key = `sem_${index}`;
                const categorization = categorizations.get(key) || 'seminar';
                const customText = categorizations.get(`${key}_custom`);
                const chosenActive = categorizations.get(`${key}_activeResearcher`);
                let categoryName = '×¡××™× ×¨';
                let displayName = '×¡××™× ×¨';

                switch (categorization) {
                    case 'seminar':
                        const prevSem = finalData.categories.get('×¡××™× ×¨') || 0;
                        finalData.categories.set('×¡××™× ×¨', prevSem + task.hours);
                        categoryName = '×¡××™× ×¨';
                        displayName = '×¡××™× ×¨';
                        break;
                    case 'active':
                        if (chosenActive) {
                            const prev = finalData.categories.get(chosenActive) || 0;
                            finalData.categories.set(chosenActive, prev + task.hours);
                            categoryName = chosenActive;
                            displayName = `×—×•×§×¨ ×¤×¢×™×œ: ${chosenActive}`;
                        } else if (activeList.length === 1) {
                            const onlyR = activeList[0];
                            const prev = finalData.categories.get(onlyR) || 0;
                            finalData.categories.set(onlyR, prev + task.hours);
                            categoryName = onlyR;
                            displayName = `×—×•×§×¨ ×¤×¢×™×œ: ${onlyR}`;
                        } else {
                            const prev = finalData.categories.get('×¡××™× ×¨ (×œ× ××•×§×¦×”)') || 0;
                            finalData.categories.set('×¡××™× ×¨ (×œ× ××•×§×¦×”)', prev + task.hours);
                            categoryName = '×¡××™× ×¨ (×œ× ××•×§×¦×”)';
                            displayName = '×¡××™× ×¨ (×œ× ××•×§×¦×”)';
                        }
                        break;
                    case 'equal':
                        if (activeList.length > 0) {
                            const portion = task.hours / activeList.length;
                            let remaining = task.hours;
                            activeList.forEach((researcher, idx) => {
                                const add = (idx === activeList.length - 1) ? +remaining.toFixed(2) : +portion.toFixed(2);
                                remaining = +(remaining - add).toFixed(2);
                                const prev = finalData.categories.get(researcher) || 0;
                                finalData.categories.set(researcher, +(prev + add).toFixed(2));
                            });
                            categoryName = `×—×œ×•×§×” ×©×•×•×” (${activeList.length} ×—×•×§×¨×™×)`;
                            displayName = `×—×œ×•×§×” ×©×•×•×” (${activeList.length} ×—×•×§×¨×™×)`;
                        } else {
                            const prev = finalData.categories.get('×¡××™× ×¨ (×œ× ××•×§×¦×”)') || 0;
                            finalData.categories.set('×¡××™× ×¨ (×œ× ××•×§×¦×”)', prev + task.hours);
                            categoryName = '×¡××™× ×¨ (×œ× ××•×§×¦×”)';
                            displayName = '×¡××™× ×¨ (×œ× ××•×§×¦×”)';
                        }
                        break;
                    case 'custom':
                        // ×©×™× ×•×™: ×”×¦×’×ª "×—×™×•×‘ ×—×“×© - {×”×˜×§×¡×˜}"
                        categoryName = customText ? `×—×™×•×‘ ×—×“×© - ${customText}` : '×—×™×•×‘ ×—×“×©';
                        const prevCustom = finalData.categories.get(categoryName) || 0;
                        finalData.categories.set(categoryName, prevCustom + task.hours);
                        displayName = categoryName;
                        break;
                    default:
                        const prevDefault = finalData.categories.get('×¡××™× ×¨') || 0;
                        finalData.categories.set('×¡××™× ×¨', prevDefault + task.hours);
                        categoryName = '×¡××™× ×¨';
                        displayName = '×¡××™× ×¨';
                }

                finalData.categorizedTasks.push({ name: task.name, category: displayName, hours: task.hours });
            });

            return finalData;
        }


        function renderFinalReport(data) {
            let html = '';

            html += `
                <div class="report-section">
                    <h3 class="section-title">×¡×š ×”×©×¢×•×ª:</h3>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>×¡×”"×› ×©×¢×•×ª</th>
                                <th>××—×•×– ××¡×š ×”×©×¢×•×ª</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.categories.forEach((hours, category) => {
                const percentage = data.totalHours > 0 ? Math.round((hours / data.totalHours) * 100) : 0;

                html += `
                    <tr>
                        <td style="font-weight: 500;">${category}</td>
                        <td style="text-align: center;">${hours}</td>
                        <td class="percentage-cell">${percentage}%</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                    <div class="calc-actions">
                        <button class="calc-btn" onclick="toggleCalculation()">×”×¦×’×ª ×—×™×©×•×‘ - ×—×œ×•×§×” ×™×—×¡×™×ª</button>
                    </div>
                    <div id="calc-panel" class="calc-panel" style="display:none;"></div>
                </div>
            `;

            if (data.categorizedTasks.length > 0) {
                 html += `
                    <div class="report-section">
                        <h3 class="section-title">×¤×™×¨×•×˜ ××©×™××•×ª ×•×¡××™× ×¨×™×:</h3>
                        ${data.categorizedTasks.map(task => `
                            <div class="hours-item other-task">
                                <span class="hours-label">${task.name} <strong>â†’ ${task.category}</strong></span>
                                <span class="hours-value">${task.hours}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            html += `
                <div class="report-section">
                    <h3 class="section-title">×™××™× ×œ×œ× ×“×™×•×•×—: <span style="color: #3b82f6;">${data.missingDays.length} ×¡×”"×› ×™××™×</span></h3>
                    <div style="display:flex; flex-wrap:wrap; gap:10px;">
                        ${data.missingDays.map(date => `<div style="background:#f1f5f9; padding: 4px 10px; border-radius:15px; font-size:0.9rem;">${date.toLocaleDateString('he-IL')}</div>`).join('') || '<div style="color:#64748b;">××™×Ÿ ×™××™× ×—×¡×¨×™× ×‘×ª×§×•×¤×” ×–×•.</div>'}
                    </div>
                </div>
            `;

            document.getElementById('final-content').innerHTML = html;
            document.getElementById('final-actions').style.display = 'flex';
        }

        // ==========================================================
        // ===== ğŸš€ START: CSV EXPORT IMPLEMENTATION ğŸš€ =====
        // ==========================================================

        /**
         * Converts an array of objects to a CSV string.
         * @param {Array<Object>} rows - The data rows.
         * @param {Array<{key: string, header: string}>} columns - Column configuration.
         * @returns {string} The CSV content.
         */
        function toCsv(rows, columns) {
            const escapeCsv = v => {
                const s = v === null || v === undefined ? '' : String(v);
                if (/[",\n]/.test(s)) return '"' + s.replaceAll('"', '""') + '"';
                return s;
            };
            const header = columns.map(c => escapeCsv(c.header)).join(',');
            const lines = rows.map(row => columns.map(c => escapeCsv(row[c.key])).join(','));
            return [header, ...lines].join('\n');
        }

        /**
         * Triggers a file download in the browser.
         * @param {string} filename - The desired name of the file.
         * @param {string} content - The file content.
         * @param {string} [type='text/csv;charset=utf-8'] - The MIME type.
         */
        function download(filename, content, type = 'text/csv;charset=utf-8') {
            // Prepend UTF-8 BOM to ensure Hebrew renders correctly in Excel
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        }

        function exportFinalReport() {
            // --- FIX: Check for data before proceeding to prevent the error ---
            if (!AppState.finalReport || !AppState.selectedEmployee || !AppState.selectedStartDate || !AppState.selectedEndDate) {
                alert('×©×’×™××”: × ×ª×•× ×™ ×”×“×•"×— ××™× × ×–××™× ×™×. × ×¡×” ×œ×”×¤×™×§ ××ª ×”×“×•"×— ××—×“×©.');
                console.error("exportFinalReport called without complete data in AppState.", AppState);
                return;
            }

            const { selectedEmployee, selectedStartDate, selectedEndDate, finalReport } = AppState;

            const employeeName = `${selectedEmployee.firstName} ${selectedEmployee.lastName}`;
            const startDateStr = selectedStartDate.toLocaleDateString('he-IL');
            const endDateStr = selectedEndDate.toLocaleDateString('he-IL');
            const dateForFilename = new Date().toISOString().slice(0, 10);

            let csvContent = '';

            // 1. Add header info
            csvContent += `×“×•"×— ×©×¢×•×ª ×¢×‘×•×¨:,${employeeName}\n`;
            csvContent += `×ª×§×•×¤×”:,${startDateStr} - ${endDateStr}\n\n`;

            // 2. Add summary table
            const summaryRows = [];
            finalReport.categories.forEach((hours, category) => {
                const percentage = finalReport.totalHours > 0 ? Math.round((hours / finalReport.totalHours) * 100) : 0;
                summaryRows.push({
                    category: category,
                    hours: hours,
                    percentage: `${percentage}%`
                });
            });
            // Add total row
            summaryRows.push({
                category: '×¡×”"×›',
                hours: finalReport.totalHours,
                percentage: '100%'
            });

            const summaryColumns = [
                { key: 'category', header: '×§×˜×’×•×¨×™×”' },
                { key: 'hours', header: '×¡×”"×› ×©×¢×•×ª' },
                { key: 'percentage', header: '××—×•×– ××¡×š ×”×©×¢×•×ª' }
            ];
            csvContent += toCsv(summaryRows, summaryColumns);

            csvContent += '\n\n'; // Add spacing

            // 3. Add Missing Days
            if (finalReport.missingDays.length > 0) {
                const missingDaysRows = finalReport.missingDays.map(date => ({
                    date: date.toLocaleDateString('he-IL')
                }));
                const missingDaysColumns = [{ key: 'date', header: '×™××™× ×œ×œ× ×“×™×•×•×—' }];
                csvContent += toCsv(missingDaysRows, missingDaysColumns);
            } else {
                csvContent += '×œ× × ××¦××• ×™××™× ×œ×œ× ×“×™×•×•×— ×‘×ª×§×•×¤×” ×–×•.\n';
            }

            // 4. Trigger download
            const filename = `work_report_${employeeName.replace(' ', '_')}_${dateForFilename}.csv`;
            download(filename, csvContent);
        }

        // ==========================================================
        // ===== ğŸš€ END: CSV EXPORT IMPLEMENTATION ğŸš€ =====
        // ==========================================================


        // Helpers
        function getSundayOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const sunday = new Date(d.getFullYear(), d.getMonth(), d.getDate() - day);
            return sunday;
        }

        function toLocalDateStr(dt) {
            return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
        }

        // Show-calculation logic
        function toggleCalculation() {
            const panel = document.getElementById('calc-panel');
            if (!panel) return;
            if (panel.style.display === 'none') {
                renderCalculationPanel(AppState.finalReport);
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function renderCalculationPanel(finalData) {
            const panel = document.getElementById('calc-panel');
            if (!panel) return;
            if (!finalData || !finalData.calculation) {
                panel.innerHTML = '<div class="empty-state">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>';
                return;
            }

            let html = '';
            html += '<div class="calc-section">';
            html += '<div class="calc-title">×—×™×©×•×‘×™ ×—×œ×•×§×” ×™×—×¡×™×ª</div>';
            const rel = finalData.calculation.relative || [];
            if (rel.length === 0) {
                html += '<div class="note">×œ× ×‘×•×¦×¢×• ×—×œ×•×§×•×ª ×™×—×¡×™×•×ª ×‘×ª×§×•×¤×” ×–×•.</div>';
            } else {
                html += '<div class="calc-grid">';
                rel.forEach((item, idx) => {
                    html += '<div class="calc-card">';
                    const taskHours = item.taskHours?.toFixed ? item.taskHours.toFixed(2) : item.taskHours;
                    html += `<div class=\"calc-subtitle\">${idx+1}. ${item.taskName || '××©×™××”'} â€” ${taskHours} ×©×¢×•×ª (${item.method==='proportional' ? '×—×œ×•×§×” ×™×—×¡×™×ª' : '×—×œ×•×§×” ×©×•×•×”'})</div>`;
                    if (item.method === 'proportional') {
                        const totalBase = item.totalBase?.toFixed ? item.totalBase.toFixed(2) : item.totalBase;
                        html += `<div class=\"equation eq-line\">×¡×”\"×› ×©×¢×•×ª ×‘×¡×™×¡ = ${totalBase}</div>`;
                    }
                    if (Array.isArray(item.items)) {
                        html += '<div class="chips">';
                        item.items.forEach(it => {
                            const baseStr = it.baseHours?.toFixed ? it.baseHours.toFixed(2) : it.baseHours;
                            const wStr = it.weight?.toFixed ? it.weight.toFixed(4) : it.weight;
                            html += `<span class=\"chip\">${it.researcher}: ×‘×¡×™×¡ ${baseStr}${item.method==='proportional' ? ` â€¢ ××©×§×œ ${wStr}` : ''}</span>`;
                        });
                        html += '</div>';
                        item.items.forEach(it => {
                            const baseStr = it.baseHours?.toFixed ? it.baseHours.toFixed(2) : it.baseHours;
                            const totalBaseStr = item.totalBase?.toFixed ? item.totalBase.toFixed(2) : item.totalBase;
                            const allocStr = it.allocated?.toFixed ? it.allocated.toFixed(2) : it.allocated;
                            if (item.method === 'proportional') {
                                html += `<div class=\"equation eq-line\">${it.researcher}: ×©×¢×•×ª ×œ×”×•×¡×¤×” = ${taskHours} Ã— (${baseStr} / ${totalBaseStr}) = ${allocStr}</div>`;
                            } else {
                                const share = item.items.length ? (1/item.items.length).toFixed(2) : 'â€”';
                                html += `<div class=\"equation eq-line\">${it.researcher}: ×©×¢×•×ª ×œ×”×•×¡×¤×” = ${taskHours} Ã— ${share} = ${allocStr}</div>`;
                            }
                        });
                    }
                    html += '</div>';
                });
                html += '</div>';
            }
            html += '</div>';
            panel.innerHTML = html;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            window.firebaseApp.auth.onAuthStateChanged(async (user) => {
                AppState.currentUser = user;
                if (user) {
                    checkManagerAccess().then(async isManager => {
                        AppState.isManager = isManager;
                        if (isManager) {
                            // ×©×™× ×•×™: ×˜×¢×™× ×ª ×©× ××œ× ××”××¡×“ × ×ª×•× ×™× ×‘××§×•× ×§×™×“×•××ª ×”××™×™×œ
                            try {
                                const { db, ref, get } = window.firebaseApp;
                                const userRef = ref(db, `users/${user.uid}`);
                                const userSnapshot = await get(userRef);

                                if (userSnapshot.exists()) {
                                    const userData = userSnapshot.val();
                                    AppState.managerName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || user.displayName || user.email.split('@')[0] || '×× ×”×œ/×ª';
                                } else {
                                    AppState.managerName = user.displayName || user.email.split('@')[0] || '×× ×”×œ/×ª';
                                }
                            } catch (error) {
                                console.error('Error loading manager name:', error);
                                AppState.managerName = user.displayName || user.email.split('@')[0] || '×× ×”×œ/×ª';
                            }

                            document.querySelector('.header-title').innerHTML = `
                                <div class="header-icon">ğŸ </div>
                                ${AppState.managerName}
                            `;
                            renderEmployeesList();
                        } else {
                            document.getElementById('employees-list').innerHTML =
                                '<div class="empty-state">××™×Ÿ ×œ×š ×”×¨×©××•×ª × ×™×”×•×œ ×‘××¢×¨×›×ª</div>';
                        }
                    }).catch(() => {
                        document.getElementById('employees-list').innerHTML =
                            '<div class="empty-state">×©×’×™××” ×‘×‘×“×™×§×ª ×”×¨×©××•×ª</div>';
                    });
                } else {
                    document.querySelector('.header-title').innerHTML = `
                        <div class="header-icon">ğŸ </div>
                        ××¢×¨×›×ª ×“×™×•×•×— ×©×¢×•×ª
                    `;
                    document.getElementById('employees-list').innerHTML =
                        '<div class="empty-state">×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×’×©×ª ×œ××¢×¨×›×ª</div>';
                }
            });
            generateCalendar();
        });

        async function checkManagerAccess() {
            try {
                const { db, ref, get } = window.firebaseApp;
                const usersRef = ref(db, 'users');
                await get(usersRef);
                return true;
            } catch (error) {
                return false;
            }
        }
    </script>
</body>
</html>