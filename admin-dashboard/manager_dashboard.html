<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3a8a">
    <title>××¢×¨×›×ª ×“×™×•×•×— ×©×¢×•×ª - × ×™×”×•×œ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/institute_icon.png">
    <link rel="shortcut icon" type="image/png" href="/institute_icon.png">
    <link rel="apple-touch-icon" href="/institute_icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', system-ui, -apple-system, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        /* Make header icon + title link to the main page */
        .home-link { display:flex; align-items:center; gap:0.75rem; color: inherit; text-decoration: none; }
        .home-link:focus-visible { outline: 3px solid rgba(59,130,246,0.25); border-radius:8px; }

        .header-icon {
            background: #3b82f6;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #64748b;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen-title {
            font-size: 2rem;
            font-weight: 600;
            color: #1e293b;
            text-align: center;
            margin-bottom: 2rem;
        }

        /* Employee List Screen */
        .employees-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 400px;
            margin: 0 auto;
        }

        .employee-button {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            font-size: 1.1rem;
            font-weight: 500;
            color: #334155;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-family: inherit;
        }

        .employee-button:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        /* Calendar Screen */
        .calendar-container {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            max-width: 500px;
            margin: 0 auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .nav-btn {
            background: #f1f5f9;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            color: #475569;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .month-year {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .calendar {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }

        .calendar th {
            padding: 1rem 0.5rem;
            font-weight: 500;
            color: #64748b;
            font-size: 0.9rem;
        }

        .calendar td {
            padding: 0;
            position: relative;
        }

        .calendar-day {
            width: 100%;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            margin: 2px;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: #f1f5f9;
        }

        .calendar-day.other-month {
            color: #cbd5e0;
        }

        .calendar-day.other-month:hover {
            background: #f1f5f9;
        }

        .calendar-day.has-reports {
            background: #22c55e;
            color: white;
            position: relative;
        }

        .calendar-day.has-reports:hover {
            background: #16a34a;
        }

        .calendar-day.range-start {
            background: #1e40af;
            color: white;
        }

        .calendar-day.range-end {
            background: #1e40af;
            color: white;
        }

        .calendar-day.in-range {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Weekly report visuals */
        .calendar-day.weekly-day {
            position: relative;
        }
        .calendar-day.weekly-day::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 6px;
            right: 6px;
            border-top: 2px dashed rgba(255,255,255,0.9);
        }
        .calendar-day.other-month.weekly-day::after {
            border-top-color: rgba(31,41,55,0.4);
        }
        .calendar-day.weekly-start::before,
        .calendar-day.weekly-end::before {
            content: '';
            position: absolute;
            top: 1px;
            width: 6px;
            height: 6px;
            border: 2px dashed rgba(255,255,255,0.9);
            border-radius: 50%;
        }
        .calendar-day.weekly-start::before { left: 2px; }
        .calendar-day.weekly-end::before { right: 2px; }
        .calendar-day.other-month.weekly-start::before,
        .calendar-day.other-month.weekly-end::before {
            border-color: rgba(31,41,55,0.4);
        }

        .date-selection-info {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            margin: 0 auto 1rem auto;
            text-align: center;
            color: #475569;
            font-size: 0.95rem;
            max-width: 500px;
            width: 100%;
            box-sizing: border-box;
        }

        .date-selection-info.has-selection {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 1rem;
            color: #1e40af;
        }

        .date-selection-info .instruction-main {
            font-size: 1.15rem;
            font-weight: 800;
            color: #0f172a;
            margin-bottom: 0.25rem;
        }

        .date-selection-info .instruction-sub {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .date-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .date-value {
            font-weight: 600;
            color: #1e293b;
        }

        .generate-report-btn {
            width: 100%;
            padding: 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }

        .generate-report-btn:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .generate-report-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .back-btn {
            width: 100%;
            padding: 0.75rem;
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: #e2e8f0;
        }

        /* Report Screens */
        .report-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .report-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .hours-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-right: 4px solid #3b82f6;
        }

        .hours-item.other-task {
            border-right-color: #f59e0b;
        }

        .hours-item.seminar {
            border-right-color: #10b981;
        }

        .hours-label {
            font-weight: 500;
            color: #374151;
        }

        .hours-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1e293b;
        }

        .categorization-item {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .categorization-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.25rem;
        }

        .task-hours {
            color: #b45309;
            font-size: 0.9rem;
        }

        .categorization-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            flex: 2;
        }

        .option-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d97706;
            background: white;
            color: #92400e;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .option-btn:hover {
            background: #fef3c7;
        }

        .option-btn.active {
            background: #d97706;
            color: white;
        }

        .option-btn .dropdown-arrow {
            margin-inline-start: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .custom-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d97706;
            border-radius: 8px;
            margin-top: 1rem;
            font-family: inherit;
            background: white;
        }

        /* Final Report */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .stats-table th,
        .stats-table td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
        }

        .stats-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .stats-table td {
            color: #1e293b;
        }

        .percentage-cell {
            text-align: center;
            font-weight: 600;
        }

        /* Show-calculation panel styles */
        .calc-actions { margin: 12px 0 0; text-align: left; }
        .calc-btn { background:#0ea5e9; color:#fff; border:none; border-radius:8px; padding:8px 12px; font-weight:600; cursor:pointer; }
        .calc-btn:hover { background:#0284c7; }
        .calc-panel { margin-top:12px; background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; }
        .calc-section { margin-bottom:16px; }
        .calc-title { font-weight:700; color:#1e293b; margin-bottom:8px; }
        .calc-grid { display:grid; grid-template-columns:1fr; gap:8px; }
        .calc-card { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:12px; }
        .calc-subtitle { color:#0f766e; font-weight:700; margin-bottom:6px; }
        .equation { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; direction:ltr; color:#334155; }
        .eq-line { margin:2px 0; }
        .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
        .chip { background:#e2e8f0; color:#0f172a; border-radius:999px; padding:2px 8px; font-size:12px; }
        .note { color:#64748b; font-size:12px; margin-top:6px; }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            margin: 1rem auto;
            animation: spin 1s linear infinite;
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        /* Action buttons layout */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }


      .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            font-family: inherit;
            min-height: 56px;
            min-width: 200px;
            max-width: 300px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .action-btn.csv {
            background: #3b82f6;
            color: white;
        }
        .action-btn.csv:hover {
            background: #2563eb;
        }

        .action-btn.pdf {
            background: #dc2626;
            color: white;
        }
        .action-btn.pdf:hover {
            background: #b91c1c;
        }

        .action-btn.database {
            background: #059669;
            color: white;
        }
        .action-btn.database:hover {
            background: #047857;
        }

        .action-btn.back {
            background: #f1f5f9;
            color: #475569;
            border: 2px solid #e2e8f0;
        }
        .action-btn.back:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }

        .action-btn-icon {
            font-size: 1.25rem;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1rem;
            }

            .categorization-header {
                flex-direction: column;
                align-items: stretch;
            }

            .categorization-options {
                justify-content: flex-start;
            }

            .action-buttons {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .action-btn {
                padding: 0.875rem 1.25rem;
                font-size: 0.95rem;
            }
        }

        /* Logout button in header */
        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.45rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
        }
        .logout-btn:hover { background: #dc2626; }

        /* Calendar legend (××§×¨×) */
        .legend {
            margin-top: 1rem;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem 1.25rem;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            color: #475569;
        }

        .legend-item { display:flex; align-items:center; gap:0.5rem; }
        .legend-swatch {
            width:18px; height:18px; border-radius:6px; display:inline-block; flex:0 0 18px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03);
        }
        .legend-swatch.report { background:#22c55e; }
        .legend-swatch.weekly { background: transparent; border-radius:4px; border: 1px solid rgba(34,197,94,0.15); position: relative; }
        .legend-swatch.weekly::after { content:''; position:absolute; left:2px; right:2px; top:4px; height:0; border-top:2px dashed #22c55e; }
        .legend-swatch.selected { background:#1e40af; }
        .legend-swatch.in-range { background:#dbeafe; border:1px solid #bfdbfe; }
        .legend-swatch.other-month { background:#cbd5e0; }
        @media (max-width:600px) {
            .legend { font-size:0.85rem; gap:0.5rem; }
        }

        .action-btn.primary {
            background: #3b82f6;
            color: white;
            font-weight: 600;
        }
        .action-btn.primary:hover {
            background: #2563eb;
        }

        .action-btn.secondary {
            background: #f8fafc;
            color: #475569;
            border: 2px solid #e2e8f0;
            font-weight: 600;
        }
        .action-btn.secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        /* Researcher Management Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.2s ease-in;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-close {
            background: #f1f5f9;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: #64748b;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .researchers-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .researcher-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .researcher-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .researcher-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-left: 0.75rem;
            cursor: pointer;
        }

        .researcher-item label {
            cursor: pointer;
            flex: 1;
            font-weight: 500;
            color: #334155;
        }

        .btn-select-researcher {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .btn-select-researcher:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .add-researcher-section {
            border-top: 2px solid #e2e8f0;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        .add-researcher-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .add-researcher-row {
            display: flex;
            gap: 0.5rem;
        }

        .add-researcher-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .add-researcher-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-add-researcher {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-add-researcher:hover {
            background: #059669;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .modal-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #2563eb;
        }

        .modal-btn.secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .modal-btn.secondary:hover {
            background: #e2e8f0;
        }
    </style>
</head>
<body>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getDatabase, ref, get, set, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        // Firebase configuration - Replace with your config
        const firebaseConfig = {
            apiKey: "AIzaSyDpzAnHPl8trZDQwC-G5twRWSwdweko_T8",
            authDomain: "work-report-volcani.firebaseapp.com",
            projectId: "work-report-volcani",
            storageBucket: "work-report-volcani.firebasestorage.app",
            messagingSenderId: "569559789764",
            appId: "1:569559789764:web:d11b9c0e43ff78a66dd991",
            measurementId: "G-M5Z4R1FB40",
            databaseURL: "https://work-report-volcani-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Make Firebase available globally (include signOut and set)
        window.firebaseApp = { app, auth, db, get, ref, set, query, orderByChild, equalTo, signOut };
    </script>

    <div class="header">
        <div class="header-title">
            <a href="#" class="home-link" id="home-link" title="×¢××•×“ ×¨××©×™" aria-label="×¢××•×“ ×¨××©×™" onclick="showEmployeesScreen(); return false;">
                <div class="header-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                </div>
                <span id="header-name">×˜×•×¢×Ÿ ××ª ×©× ×”×× ×”×œ/×ª...</span>
            </a>
        </div>
        <div class="user-profile">

            <button class="logout-btn" onclick="logout()" title="×”×ª× ×ª×§/×™">×”×ª× ×ª×§/×™</button>
        </div>
    </div>

    <div class="container">
        <div id="employees-screen" class="screen active">
            <h1 class="screen-title">×¢×•×‘×“×™× ×¤×¢×™×œ×™×</h1>
            <div class="employees-list" id="employees-list">
                <div class="loading">×˜×•×¢×Ÿ ×¨×©×™××ª ×¢×•×‘×“×™×/×•×ª...</div>
            </div>
        </div>

        <div id="calendar-screen" class="screen">
            <h1 class="screen-title" id="calendar-title">×¢×•×‘×“ - ×”×¤×§×ª ×“×•"×—</h1>
            <div class="date-selection-info" id="date-selection">
                <div class="instruction-main">×™×© ×œ×‘×—×•×¨ ×ª××¨×™×š ×”×ª×—×œ×” ×•×¡×™×•× ×œ×”×¤×§×ª ×“×•"×—</div>
                <div class="instruction-sub">(×ª××¨×™×›×™× ××—×•×“×©×™× ××—×¨×™× ××•×¦×’×™× ×‘××¤×•×¨)</div>
            </div>
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="nav-btn" onclick="previousMonth()">â€¹</button>
                    <div class="month-year" id="month-year">××•×’×•×¡×˜ 2025</div>
                    <button class="nav-btn" onclick="nextMonth()">â€º</button>
                </div>

                <table class="calendar">
                    <thead>
                        <tr>
                            <th>×</th>
                            <th>×‘</th>
                            <th>×’</th>
                            <th>×“</th>
                            <th>×”</th>
                            <th>×•</th>
                            <th>×©</th>
                        </tr>
                    </thead>
                    <tbody id="calendar-body"></tbody>
                </table>

                <button class="generate-report-btn" id="generate-report" disabled onclick="generateIntermediateReport()">
                    ×”×¤×§×ª ×“×•"×— ×©×¢×•×ª
                </button>

                <button class="back-btn" onclick="showEmployeesScreen()">×—×–×¨×”</button>

                <div class="legend" aria-hidden="false">
                    <div class="legend-item"><span class="legend-swatch report" aria-hidden="true"></span><span>×§×™×™× ×“×™×•×•×— ×™×•××™</span></div>
                    <div class="legend-item"><span class="legend-swatch weekly" aria-hidden="true"></span><span>×§×™×™× ×“×™×•×•×— ×©×‘×•×¢×™</span></div>
                </div>
             </div>
         </div>

        <div id="intermediate-screen" class="screen">
            <div class="report-container">
                <h1 class="screen-title" id="intermediate-title">×¢×•×‘×“ - ×”×¤×§×ª ×“×•"×— ×¤×¢×™×œ×•×ª - ××¡×š ×‘×™× ×™×™×</h1>
                <p style="text-align: center; color: #64748b; margin-bottom: 2rem;" id="intermediate-subtitle">×œ×ª×§×•×¤×”</p>

                <div id="intermediate-content">
                    <div class="loading">××¢×‘×“ × ×ª×•× ×™ ×“×™×•×•×—...</div>
                </div>

                <div class="action-buttons" id="intermediate-actions" style="display: none;">
                    <button class="action-btn primary" onclick="generateFinalReport()">
                        ××™×©×•×¨ ×©×¢×•×ª ×“×•"×—
                    </button>
                    <button class="action-btn secondary" onclick="showCalendarScreen(null, false)">×—×–×¨×”</button>
                </div>
            </div>
        </div>

        <div id="final-screen" class="screen">
            <div class="report-container">
                <h1 class="screen-title" id="final-title">×¢×•×‘×“ - ×“×•"×—</h1>
                <p style="text-align: center; color: #64748b; margin-bottom: 2rem;" id="final-subtitle">×œ×ª×§×•×¤×”</p>

                <div id="final-content">
                    <div class="loading">××›×™×Ÿ ×“×•"×— ×¡×•×¤×™...</div>
                </div>

                <div class="report-section" id="chart-section" style="display: none;">
                    <h3 class="section-title">×”×ª×¤×œ×’×•×ª ×©×¢×•×ª</h3>
                    <div style="max-width: 600px; margin: 0 auto; position: relative; height: 400px;">
                        <canvas id="hoursChart"></canvas>
                    </div>
                </div>

                <div class="action-buttons" id="final-actions" style="display: none;">
                    <button class="action-btn csv" onclick="exportFinalReport()">
                        <span class="action-btn-icon">ğŸ“Š</span>
                        <span>×”×¤×§×ª ×“×•"×— CSV ××¢×•×‘×“</span>
                    </button>
                    <button class="action-btn pdf" onclick="openPdfReport()">
                        <span class="action-btn-icon">ğŸ“„</span>
                        <span>×”×¤×§×ª ×“×•"×— PDF</span>
                    </button>
                    <button class="action-btn database" onclick="openDbReport()">
                        <span class="action-btn-icon">ğŸ—„ï¸</span>
                        <span>×“×•"×— × ×ª×•× ×™× ×’×•×œ××™×™×</span>
                    </button>
                    <button class="action-btn back" onclick="showIntermediateScreen()">
                        <span class="action-btn-icon">â†©ï¸</span>
                        <span>×—×–×¨×”</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Researcher Management Modal -->
    <div class="modal-overlay" id="researcher-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">× ×™×”×•×œ ×—×•×§×¨×™× ×¤×¢×™×œ×™×</h2>
                <button class="modal-close" onclick="closeResearcherModal()" aria-label="×¡×’×•×¨">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="researchers-grid" id="modal-researchers-list">
                    <!-- Will be populated dynamically -->
                </div>
                <div class="add-researcher-section">
                    <div class="add-researcher-title">×”×•×¡×¤×ª ×—×•×§×¨/×ª ×—×“×©/×”</div>
                    <div class="add-researcher-row">
                        <input type="text" id="modal-new-researcher-name" class="add-researcher-input" placeholder="×™×© ×œ×”×–×™×Ÿ ××ª ×©× ×”×—×•×§×¨/×ª ×”×—×“×©/×”..." maxlength="50">
                        <button class="btn-add-researcher" onclick="addNewResearcherFromModal()">×”×•×¡×¤×”</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn primary" onclick="saveResearchersFromModal()">×©××™×¨×”</button>
                <button class="modal-btn secondary" onclick="closeResearcherModal()">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        const AppState = {
            currentUser: null,
            isManager: false,
            managerName: '',
            employees: [],
            selectedEmployee: null,
            selectedStartDate: null,
            selectedEndDate: null,
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            reportData: null,
            categorizations: new Map(),
            finalReport: null,
            isGrouped: false,
            currentActiveResearcherInput: null // Track which dropdown was last clicked
        };

        const CACHE_PREFIX = 'reportCategorizationCache_';

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
                max-width: 400px;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Helper to format hours - shows integer if whole, otherwise shows decimal
        const formatHours = (hours) => parseFloat(Number(hours).toFixed(2));

        function getCacheKey() {
            if (!AppState.selectedEmployee) return null;
            return `${CACHE_PREFIX}${AppState.selectedEmployee.id}`;
        }

        function saveCategorizationsToCache() {
            const key = getCacheKey();
            if (!key) return;
            const dataToSave = Object.fromEntries(AppState.categorizations.entries());
            localStorage.setItem(key, JSON.stringify(dataToSave));
        }

        function loadCategorizationsFromCache() {
            const key = getCacheKey();
            if (!key) return new Map();
            const savedData = localStorage.getItem(key);
            if (savedData) {
                try {
                    return new Map(Object.entries(JSON.parse(savedData)));
                } catch (e) {
                    console.error('Error parsing cached categorizations:', e);
                    return new Map();
                }
            }
            return new Map();
        }

        async function loadEmployeesForManager(managerName) {
            const { db, ref, get } = window.firebaseApp;
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);
            if (!snapshot.exists()) return [];

            const employees = [];
            const data = snapshot.val();
            Object.entries(data).forEach(([userId, userData]) => {
                if (userData.my_manager) {
                    const storedManagerInfo = userData.my_manager;
                    if (storedManagerInfo.includes(managerName) || storedManagerInfo.includes(AppState.currentUser?.email || '')) {
                        employees.push({ id: userId, ...userData });
                    }
                }
            });
            return employees;
        }

        function normalizeEntries(entries) {
            if (Array.isArray(entries)) return entries.filter(e => e != null);
            if (entries && typeof entries === 'object') return Object.values(entries).filter(e => e != null);
            return [];
        }

        async function loadEmployeeReports(employeeId, startDate, endDate) {
            const { db, ref, get } = window.firebaseApp;
            const reportsRef = ref(db, `reports/${employeeId}`);
            const snapshot = await get(reportsRef);
            if (!snapshot.exists()) return [];

            const reports = [];
            const data = snapshot.val();
            const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());

            Object.entries(data).forEach(([reportId, reportData]) => {
                const reportDateObj = new Date(reportData.date);
                const reportDateOnly = new Date(reportDateObj.getFullYear(), reportDateObj.getMonth(), reportDateObj.getDate());
                let include = false;
                if (reportData.type === 'weekly') {
                    const weekStart = getSundayOfWeek(reportDateOnly);
                    const weekEndThu = new Date(weekStart);
                    weekEndThu.setDate(weekStart.getDate() + 4);
                    include = weekEndThu >= start && weekStart <= end;
                } else {
                    include = reportDateOnly >= start && reportDateOnly <= end;
                }
                if (include) {
                    reports.push({
                        id: reportId,
                        date: `${reportDateOnly.getFullYear()}-${String(reportDateOnly.getMonth()+1).padStart(2,'0')}-${String(reportDateOnly.getDate()).padStart(2,'0')}`,
                        type: reportData.type,
                        entries: normalizeEntries(reportData.entries),
                        workStatus: reportData.workStatus
                    });
                }
            });
            return reports.sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        async function getReportDatesForEmployee(employeeId, year, month) {
            const { db, ref, get } = window.firebaseApp;
            const reportsRef = ref(db, `reports/${employeeId}`);
            const snapshot = await get(reportsRef);
            if (!snapshot.exists()) return { reportedDays: new Set(), weeklyDays: new Set() };

            const reportedDays = new Set();
            const weeklyDays = new Set();
            const data = snapshot.val();
            Object.values(data).forEach(report => {
                const dateStr = typeof report.date === 'string' ? report.date.split('T')[0] : null;
                if (!dateStr) return;
                const [y, m, d] = dateStr.split('-').map(Number);
                const reportDate = new Date(y, m - 1, d);
                if (report.type === 'weekly') {
                    const weekStart = getSundayOfWeek(reportDate);
                    for (let i = 0; i <= 4; i++) {
                        const cur = new Date(weekStart);
                        cur.setDate(weekStart.getDate() + i);
                        if (cur.getFullYear() === year && cur.getMonth() === month) {
                            reportedDays.add(cur.getDate());
                            weeklyDays.add(cur.getDate());
                        }
                    }
                } else {
                    if (reportDate.getFullYear() === year && reportDate.getMonth() === month) {
                        reportedDays.add(reportDate.getDate());
                    }
                }
            });
            return { reportedDays, weeklyDays };
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showEmployeesScreen() { showScreen('employees-screen'); }

        function showCalendarScreen(employee, shouldResetDates = true) {
            if (employee) {
                AppState.selectedEmployee = employee;
                document.getElementById('calendar-title').textContent = `${employee.firstName} ${employee.lastName} - ×¤×¢×™×œ×•×ª`;
            }
            if (shouldResetDates) {
                AppState.selectedStartDate = null;
                AppState.selectedEndDate = null;
            }
            updateDateSelection();
            updateGenerateButton();
            showScreen('calendar-screen');
            generateCalendar();
        }

        function showIntermediateScreen() {
            const { selectedEmployee, selectedStartDate, selectedEndDate } = AppState;
            const startDateStr = selectedStartDate.toLocaleDateString('he-IL');
            const endDateStr = selectedEndDate.toLocaleDateString('he-IL');
            document.getElementById('intermediate-title').textContent = `${selectedEmployee.firstName} ${selectedEmployee.lastName} - ×”×¤×§×ª ×“×•"×— ×¤×¢×™×œ×•×ª - ××¡×š ×‘×™× ×™×™×`;
            document.getElementById('intermediate-subtitle').textContent = `×œ×ª×§×•×¤×” ${startDateStr} - ${endDateStr}`;
            showScreen('intermediate-screen');
        }

        function showFinalScreen() {
            const { selectedEmployee, selectedStartDate, selectedEndDate } = AppState;
            const startDateStr = selectedStartDate.toLocaleDateString('he-IL');
            const endDateStr = selectedEndDate.toLocaleDateString('he-IL');
            document.getElementById('final-title').textContent = `${selectedEmployee.firstName} ${selectedEmployee.lastName} - ×“×•"×—`;
            document.getElementById('final-subtitle').textContent = `×œ×ª×§×•×¤×” ${startDateStr} - ${endDateStr}`;
            showScreen('final-screen');
        }

        async function renderEmployeesList() {
            const container = document.getElementById('employees-list');
            if (!AppState.isManager) {
                container.innerHTML = '<div class="empty-state">×™×© ×œ×”×ª×—×‘×¨ ×›×× ×”×œ/×ª ×›×“×™ ×œ×¦×¤×•×ª ×‘×¨×©×™××ª ×”×¢×•×‘×“×™×</div>';
                return;
            }
            try {
                const employees = await loadEmployeesForManager(AppState.managerName);
                AppState.employees = employees;
                if (employees.length === 0) {
                    container.innerHTML = '<div class="empty-state">×œ× × ××¦××• ×¢×•×‘×“×™× ×”××©×•×™×›×™× ××œ×™×š</div>';
                    return;
                }
                container.innerHTML = employees.map(emp => `
                    <button class="employee-button" onclick='showCalendarScreen(${JSON.stringify(emp).replace(/"/g, "&quot;")})'>
                        ${emp.firstName} ${emp.lastName}
                    </button>`).join('');
            } catch (error) {
                console.error('Error rendering employees:', error);
                container.innerHTML = '<div class="empty-state">×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”×¢×•×‘×“×™×</div>';
            }
        }

        async function generateCalendar() {
            const monthNames = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
            document.getElementById('month-year').textContent = `${monthNames[AppState.currentMonth]} ${AppState.currentYear}`;
            const firstDay = new Date(AppState.currentYear, AppState.currentMonth, 1).getDay();
            const calendarBody = document.getElementById('calendar-body');
            calendarBody.innerHTML = '';

            let reportMeta = { reportedDays: new Set(), weeklyDays: new Set() };
            if (AppState.selectedEmployee) {
                reportMeta = await getReportDatesForEmployee(AppState.selectedEmployee.id, AppState.currentYear, AppState.currentMonth);
            }

            const startDate = new Date(AppState.currentYear, AppState.currentMonth, 1);
            startDate.setDate(startDate.getDate() - firstDay);
            for (let week = 0; week < 6; week++) {
                const row = document.createElement('tr');
                for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                    const cell = document.createElement('td');
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    const currentDate = new Date(startDate);
                    dayDiv.textContent = currentDate.getDate();
                    dayDiv.dataset.date = toLocalDateStr(currentDate);

                    if (currentDate.getMonth() !== AppState.currentMonth) dayDiv.classList.add('other-month');

                    const dayNum = currentDate.getDate();
                    if (reportMeta.reportedDays.has(dayNum) && currentDate.getMonth() === AppState.currentMonth) dayDiv.classList.add('has-reports');
                    if (reportMeta.weeklyDays.has(dayNum) && currentDate.getMonth() === AppState.currentMonth) {
                        dayDiv.classList.add('weekly-day');
                        const dow = currentDate.getDay();
                        if (dow === 0) dayDiv.classList.add('weekly-start');
                        if (dow === 4) dayDiv.classList.add('weekly-end');
                    }
                    dayDiv.addEventListener('click', () => selectDate(new Date(currentDate)));
                    cell.appendChild(dayDiv);
                    row.appendChild(cell);
                    startDate.setDate(startDate.getDate() + 1);
                }
                calendarBody.appendChild(row);
                 if (startDate > new Date(AppState.currentYear, AppState.currentMonth + 1, 0) && week > 3) break;
            }
            updateCalendarSelection();
        }

        function selectDate(clickedDate) {
            if (!AppState.selectedStartDate || (AppState.selectedStartDate && AppState.selectedEndDate)) {
                AppState.selectedStartDate = clickedDate;
                AppState.selectedEndDate = null;
            } else if (clickedDate >= AppState.selectedStartDate) {
                AppState.selectedEndDate = clickedDate;
            } else {
                AppState.selectedStartDate = clickedDate;
                AppState.selectedEndDate = null;
            }
            updateCalendarSelection();
            updateDateSelection();
            updateGenerateButton();
        }

        function updateCalendarSelection() {
            document.querySelectorAll('.calendar-day[data-date]').forEach(day => {
                day.classList.remove('range-start', 'range-end', 'in-range');
                const dayDateStr = day.dataset.date;
                if (!dayDateStr) return;
                const startDateStr = AppState.selectedStartDate ? toLocalDateStr(AppState.selectedStartDate) : null;
                const endDateStr = AppState.selectedEndDate ? toLocalDateStr(AppState.selectedEndDate) : null;
                if (startDateStr && dayDateStr === startDateStr) day.classList.add('range-start');
                else if (endDateStr && dayDateStr === endDateStr) day.classList.add('range-end');
                else if (startDateStr && endDateStr && dayDateStr > startDateStr && dayDateStr < endDateStr) day.classList.add('in-range');
            });
        }

        function updateDateSelection() {
            const container = document.getElementById('date-selection');
            if (AppState.selectedStartDate && AppState.selectedEndDate) {
                const startStr = AppState.selectedStartDate.toLocaleDateString('he-IL');
                const endStr = AppState.selectedEndDate.toLocaleDateString('he-IL');
                container.className = 'date-selection-info has-selection';
                container.innerHTML = `<div class="date-label">×˜×•×•×— × ×‘×—×¨</div><div class="date-value">${startStr} - ${endStr}</div>`;
            } else if (AppState.selectedStartDate) {
                const startStr = AppState.selectedStartDate.toLocaleDateString('he-IL');
                container.className = 'date-selection-info has-selection';
                container.innerHTML = `<div class="date-label">×ª××¨×™×š ×”×ª×—×œ×”</div><div class="date-value">${startStr}</div><div style="margin-top: 0.5rem; font-size: 0.8rem;">×‘×—×¨/×™ ×ª××¨×™×š ×¡×™×•×</div>`;
            } else {
                container.className = 'date-selection-info';
                container.innerHTML = `<div class="instruction-main">×™×© ×œ×‘×—×•×¨ ×ª××¨×™×š ×”×ª×—×œ×” ×•×¡×™×•× ×œ×”×¤×§×ª ×“×•"×—</div><div class="instruction-sub">(×ª××¨×™×›×™× ××—×•×“×©×™× ××—×¨×™× ××•×¦×’×™× ×‘××¤×•×¨)</div>`;
             }
         }

        function updateGenerateButton() {
            document.getElementById('generate-report').disabled = !(AppState.selectedStartDate && AppState.selectedEndDate);
        }

        function previousMonth() {
            if (AppState.currentMonth === 0) { AppState.currentMonth = 11; AppState.currentYear--; }
            else { AppState.currentMonth--; }
            generateCalendar();
        }

        function nextMonth() {
            if (AppState.currentMonth === 11) { AppState.currentMonth = 0; AppState.currentYear++; }
            else { AppState.currentMonth++; }
            generateCalendar();
        }

        async function generateIntermediateReport() {
            showIntermediateScreen();
            try {
                const reports = await loadEmployeeReports(AppState.selectedEmployee.id, AppState.selectedStartDate, AppState.selectedEndDate);
                AppState.reportData = processReportData(reports);
                AppState.categorizations = loadCategorizationsFromCache();
                renderIntermediateReport(AppState.reportData);
            } catch (error) {
                console.error('Error generating intermediate report:', error);
                document.getElementById('intermediate-content').innerHTML = '<div class="empty-state">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×“×™×•×•×—</div>';
            }
        }

        function processReportData(reports) {
            const data = { researchers: new Map(), otherTasks: [], seminars: [], totalHours: 0, workDays: new Set(), missingDays: [] };
            reports.forEach(report => {
                const baseDate = new Date(report.date);
                if (report.type === 'weekly') {
                    const weekStart = getSundayOfWeek(baseDate);
                    for (let i = 0; i <= 4; i++) {
                        const cur = new Date(weekStart);
                        cur.setDate(weekStart.getDate() + i);
                        data.workDays.add(toLocalDateStr(cur));
                    }
                } else {
                    data.workDays.add(toLocalDateStr(baseDate));
                }

                report.entries.forEach((entry, entryIndex) => {
                    let hours = 0;
                    if (report.type === 'weekly') {
                        if (entry?.hours != null && entry.hours !== '') hours = parseFloat(entry.hours) || 0;
                        else if (entry?.days != null && entry.days !== '') hours = (parseFloat(entry.days) || 0) * 8;
                        else if (Array.isArray(entry?.dailyHours)) hours = entry.dailyHours.reduce((sum, h) => sum + (parseFloat(h) || 0), 0);
                    } else {
                        hours = parseFloat(entry?.hours) || 0;
                    }
                    data.totalHours += hours;

                    const isSeminar = entry.researcher?.includes('×¡××™× ×¨') || entry.researcher?.includes('×§×•×¨×¡') || entry.researcher?.includes('×”×›×©×¨×”');
                    const stableId = `${report.id}_${entryIndex}`;
                    const taskObject = {
                        id: stableId,
                        name: entry.detail || entry.researcher || '×œ× ××•×’×“×¨',
                        hours: hours,
                        date: report.date
                    };

                    if (isSeminar) data.seminars.push(taskObject);
                    else if (entry.researcher === '××©×™××•×ª ××—×¨×•×ª') data.otherTasks.push(taskObject);
                    else {
                        const current = data.researchers.get(entry.researcher) || 0;
                        data.researchers.set(entry.researcher, formatHours(current + hours));
                    }
                });
            });

            data.missingDays = calculateMissingDays(AppState.selectedStartDate, AppState.selectedEndDate, data.workDays);
            return data;
        }

        function calculateMissingDays(startDate, endDate, workDays) {
            const missing = [];
            const current = new Date(startDate);
            while (current <= endDate) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek !== 5 && dayOfWeek !== 6) { // Not Friday or Saturday
                    if (!workDays.has(toLocalDateStr(current))) {
                        missing.push(new Date(current));
                    }
                }
                current.setDate(current.getDate() + 1);
            }
            return missing;
        }

        // Grouping Helper Functions attached to window
        window.toggleGrouping = function() {
            AppState.isGrouped = !AppState.isGrouped;
            renderIntermediateReport(AppState.reportData);
        };

        window.selectGroupCategorization = function(idsString, type) {
            const ids = idsString.split(',');
            ids.forEach(id => {
                AppState.categorizations.delete(`${id}_custom`);
                AppState.categorizations.delete(`${id}_activeResearcher`);
                AppState.categorizations.set(id, type);
            });
            saveCategorizationsToCache();
            renderIntermediateReport(AppState.reportData);
        };

        window.updateGroupCustomText = function(idsString, value) {
            const ids = idsString.split(',');
            ids.forEach(id => {
                AppState.categorizations.set(`${id}_custom`, value);
            });
            saveCategorizationsToCache();
        };

        window.updateGroupActiveResearcher = function(idsString, value) {
            const ids = idsString.split(',');
            ids.forEach(id => {
                AppState.categorizations.set(`${id}_activeResearcher`, value);
            });
            saveCategorizationsToCache();
        };

        // Handle active researcher selection change
        window.handleActiveResearcherChange = function(taskId, value, isGroup) {
            if (value === '__other__') {
                // Open the modal to manage researchers
                openResearcherModal();
                // Reset the dropdown to empty
                const select = event.target;
                if (select) {
                    select.value = '';
                }
                return;
            }

            // Normal selection handling
            if (isGroup) {
                updateGroupActiveResearcher(taskId, value);
            } else {
                AppState.categorizations.set(`${taskId}_activeResearcher`, value);
                saveCategorizationsToCache();
            }
        };

        function renderTaskItem(task, isOtherTask) {
            // Check first ID for status (assuming group consistency)
            const firstId = task.originalIds ? task.originalIds[0] : task.id;

            const savedType = AppState.categorizations.get(firstId);
            const savedCustomText = AppState.categorizations.get(`${firstId}_custom`) || '';
            const savedActiveResearcher = AppState.categorizations.get(`${firstId}_activeResearcher`) || '';

            const buttonType = isOtherTask ? 'relative' : 'equal';
            const buttonText = isOtherTask ? '×—×œ×•×§×” ×™×—×¡×™×ª' : '×—×œ×•×§×” ×©×•×•×”';

            let selectCall, inputCall, activeCall;

            if (task.isGroup) {
                selectCall = `selectGroupCategorization('${task.id}',`;
                inputCall = `updateGroupCustomText('${task.id}', this.value)`;
                activeCall = `handleActiveResearcherChange('${task.id}', this.value, true)`;
            } else {
                selectCall = `selectCategorization('${task.id}',`;
                inputCall = `AppState.categorizations.set('${task.id}_custom', this.value); saveCategorizationsToCache();`;
                activeCall = `handleActiveResearcherChange('${task.id}', this.value, false)`;
            }

            const groupBadge = (task.isGroup && task.count > 1)
                ? `<span style="background:#eff6ff; color:#1d4ed8; font-size:0.75rem; font-weight:600; padding:2px 8px; border-radius:12px; margin-inline-start:8px; border:1px solid #bfdbfe;">××§×•×‘×¥ ×-${task.count}</span>`
                : '';

            let itemHtml = `
                <div class="categorization-item">
                    <div class="categorization-header">
                        <div class="task-info">
                            <div class="task-name">${task.name} ${groupBadge}</div>
                            <div class="task-hours">×¡×”"×› ×©×¢×•×ª: ${formatHours(task.hours)}</div>
                        </div>
                        <div class="categorization-options">
                            <button class="option-btn ${savedType === 'seminar' ? 'active' : ''}" onclick="${selectCall} 'seminar')">×¡××™× ×¨</button>
                            <button class="option-btn ${savedType === 'active' ? 'active' : ''}" onclick="${selectCall} 'active')">×—×•×§×¨ ×¤×¢×™×œ <span class="dropdown-arrow">â–¾</span></button>
                            <button class="option-btn ${savedType === buttonType ? 'active' : ''}" onclick="${selectCall} '${buttonType}')">${buttonText}</button>
                            <button class="option-btn ${savedType === 'custom' ? 'active' : ''}" onclick="${selectCall} 'custom')">×—×™×•×‘ ×—×“×©</button>
                        </div>
                    </div>
                    <div id="${task.isGroup ? 'group' : task.id}_dynamic_content">`;

            if (savedType === 'custom') {
                itemHtml += `<input class="custom-input" placeholder="×”×•×¡×¤×ª ×”×¡×‘×¨ ×œ×—×™×•×‘ ××• ×—×•×§×¨/×ª ×œ×—×™×•×‘..." value="${savedCustomText}" oninput="${inputCall}" />`;
            } else if (savedType === 'active') {
                const activeList = AppState.selectedEmployee?.activeResearchers || [];
                if (activeList.length > 0) {
                    itemHtml += `<select class="active-select custom-input" style="margin-top: 0.75rem;" onchange="${activeCall}">
                        <option value="">×‘×—×¨/×™ ×—×•×§×¨/×ª ×¤×¢×™×œ/×”...</option>
                        ${activeList.map(r => `<option value="${r}" ${r === savedActiveResearcher ? 'selected' : ''}>${r}</option>`).join('')}
                        <option value="__other__">---- ××—×¨ ----</option>
                    </select>`;
                } else {
                    itemHtml += `<div style="margin-top: 0.75rem; padding: 0.75rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; color: #856404; text-align: center;">
                        ××™×Ÿ ×—×•×§×¨×™× ×¤×¢×™×œ×™×. <a href="#" onclick="openResearcherModal(); return false;" style="color: #0066cc; text-decoration: underline;">×œ×—×¥ ×›××Ÿ ×œ× ×™×”×•×œ ×—×•×§×¨×™×</a>
                    </div>`;
                }
            }
            itemHtml += `</div></div>`;
            return itemHtml;
        }

        function renderIntermediateReport(data) {
            let html = '';

            if (data.researchers.size > 0) {
                html += `<div class="report-section"><h3 class="section-title">×—×•×§×¨×™×:</h3>`;
                data.researchers.forEach((hours, researcher) => {
                    html += `<div class="hours-item"><span class="hours-label">${researcher} - ×¡×”"×› ×©×¢×•×ª</span><span class="hours-value">${formatHours(hours)}</span></div>`;
                });
                html += '</div>';
            }

            if (data.otherTasks.length > 0) {
                html += `<div class="report-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                        <h3 class="section-title" style="margin-bottom:0; border:none;">××©×™××•×ª × ×•×¡×¤×•×ª:</h3>
                        <button onclick="toggleGrouping()" style="background: ${AppState.isGrouped ? '#e0f2fe' : '#f1f5f9'}; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; color: #334155; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;">
                            ${AppState.isGrouped ? '<span style="color:#0ea5e9; font-weight:bold;">âœ“</span> ××§×•×‘×¥' : '<span style="filter: grayscale(1);">â¬œ</span> ×§×™×‘×•×¥ ×“×•××™×'}
                        </button>
                    </div>`;

                let tasksToRender = [];

                if (AppState.isGrouped) {
                    const groups = {};
                    data.otherTasks.forEach(task => {
                        const cleanName = task.name.trim();
                        if (!groups[cleanName]) {
                            groups[cleanName] = {
                                ids: [],
                                name: cleanName,
                                hours: 0,
                                date: task.date
                            };
                        }
                        groups[cleanName].ids.push(task.id);
                        groups[cleanName].hours += task.hours;
                    });

                    tasksToRender = Object.values(groups).map(g => ({
                        id: g.ids.join(','),
                        isGroup: true,
                        count: g.ids.length,
                        originalIds: g.ids,
                        name: g.name,
                        hours: g.hours
                    }));
                } else {
                    tasksToRender = data.otherTasks.map(t => ({...t, isGroup: false, count: 1, originalIds: [t.id]}));
                }

                tasksToRender.forEach(task => {
                    html += renderTaskItem(task, true);
                });
                html += '</div>';
            }

            if (data.seminars.length > 0) {
                html += `<div class="report-section"><h3 class="section-title">×¡××™× ×¨/×§×•×¨×¡/×”×›×©×¨×”:</h3>`;
                data.seminars.forEach(task => {
                    html += renderTaskItem({...task, isGroup: false, originalIds: [task.id]}, false);
                });
                html += '</div>';
            }

            if (html.indexOf('categorization-item') === -1 && data.researchers.size === 0) {
                html = '<div class="empty-state">×œ× × ××¦××• ×“×™×•×•×—×™× ×œ×ª×§×•×¤×” ×”× ×‘×—×¨×ª</div>';
            }

            document.getElementById('intermediate-content').innerHTML = html;
            document.getElementById('intermediate-actions').style.display = 'flex';
        }

        function selectCategorization(taskStableId, type) {
            AppState.categorizations.delete(`${taskStableId}_custom`);
            AppState.categorizations.delete(`${taskStableId}_activeResearcher`);
            AppState.categorizations.set(taskStableId, type);
            saveCategorizationsToCache();
            renderIntermediateReport(AppState.reportData);
        }

        async function generateFinalReport() {
            showFinalScreen();
            try {
                const finalData = processFinalReport(AppState.reportData, AppState.categorizations);
                AppState.finalReport = finalData;
                renderFinalReport(finalData);
            } catch (error) {
                console.error('Error generating final report:', error);
                document.getElementById('final-content').innerHTML = '<div class="empty-state">×©×’×™××” ×‘×”×›× ×ª ×”×“×•"×— ×”×¡×•×¤×™</div>';
            }
        }

        function processFinalReport(data, categorizations) {
            const finalData = {
                categories: new Map(),
                totalHours: data.totalHours, // ×©×™× ×œ×‘: ×–×” ×”×¡×›×•× ×”××§×•×¨×™, ×× ×ª×¨×¦×” ×©×™×ª×¢×“×›×Ÿ ×™×© ×œ×¡×›×•× ××—×“×©
                categorizedTasks: [],
                missingDays: data.missingDays,
                calculation: { relative: [] }
            };

            // ××ª×—×•×œ ×”×§×˜×’×•×¨×™×•×ª ×¢× ×”× ×ª×•× ×™× ×”××§×•×¨×™×™×
            data.researchers.forEach((hours, researcher) => {
                finalData.categories.set(researcher, hours); // ×›××Ÿ ×”×¡×¨× ×• ××ª formatHours ×›×—×œ×§ ××”×ª×™×§×•×Ÿ ×”×§×•×“×
            });

            // ×¨×©×™××•×ª ×¢×–×¨ ×œ×¤×™×¦×•×œ ×”×¢×™×‘×•×“
            const fixedTasks = [];
            const relativeTasks = [];

            // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ××™×•×Ÿ ×”××©×™××•×ª
            const classifyTask = (task, isOtherTask) => {
                const key = task.id;
                const defaultCategorization = isOtherTask ? null : 'seminar';
                const categorization = categorizations.get(key) || defaultCategorization;

                // ×× ×–×• ×—×œ×•×§×” ×™×—×¡×™×ª ××• ×©×•×•×” - ×©×•×œ×—×™× ×œ×¡×™×‘×•×‘ ×©× ×™
                if (categorization === 'relative' || categorization === 'equal') {
                    relativeTasks.push({ task, categorization, key });
                } else {
                    fixedTasks.push({ task, categorization, key });
                }
            };

            // ××™×•×Ÿ ×›×œ ×”××©×™××•×ª
            data.otherTasks.forEach(t => classifyTask(t, true));
            data.seminars.forEach(t => classifyTask(t, false));

            // ×œ×•×’×™×§×” ×œ×¢×™×‘×•×“ ××©×™××” (××©×•×ª×¤×ª ×œ×©× ×™ ×”×©×œ×‘×™×)
            const processSingleTask = (item) => {
                const { task, categorization, key } = item;
                const customText = categorizations.get(`${key}_custom`);
                const chosenActive = categorizations.get(`${key}_activeResearcher`);
                let displayName = '×œ× ××§×•×˜×œ×’';

                switch (categorization) {
                    case 'active':
                        if (chosenActive) {
                            const prev = finalData.categories.get(chosenActive) || 0;
                            // ×ª×™×§×•×Ÿ: ×©×™××•×© ×‘×—×™×‘×•×¨ ×¨×’×™×œ ×œ×œ× formatHours
                            finalData.categories.set(chosenActive, prev + task.hours);
                            displayName = `×—×•×§×¨ ×¤×¢×™×œ: ${chosenActive}`;
                        } else {
                            displayName = '×—×•×§×¨ ×¤×¢×™×œ (×œ× × ×‘×—×¨)';
                            const prev = finalData.categories.get(displayName) || 0;
                            finalData.categories.set(displayName, prev + task.hours);
                        }
                        break;

                    case 'equal':
                        // ×ª×™×§×•×Ÿ: ××¡×ª×›×œ×™× ×¢×œ ×”×—×•×§×¨×™× ×©×™×© ×œ×”× ×©×¢×•×ª ×‘-finalData ×”××¢×•×“×›×Ÿ
                        const researchersForEqual = Array.from(finalData.categories.keys()).filter(r => (finalData.categories.get(r) || 0) > 0);

                        if (researchersForEqual.length > 0) {
                            const portion = task.hours / researchersForEqual.length;
                            let remaining = task.hours;
                            researchersForEqual.forEach((r, idx) => {
                                const toAdd = (idx === researchersForEqual.length - 1) ? remaining : portion;
                                remaining -= toAdd;
                                const prev = finalData.categories.get(r) || 0;
                                finalData.categories.set(r, prev + toAdd);
                            });
                            displayName = `×—×œ×•×§×” ×©×•×•×” (${researchersForEqual.length} ×—×•×§×¨×™×)`;
                        } else {
                            displayName = '×—×œ×•×§×” ×©×•×•×” (××™×Ÿ ×—×•×§×¨×™× ×¤×¢×™×œ×™×)';
                            const prev = finalData.categories.get(displayName) || 0;
                            finalData.categories.set(displayName, prev + task.hours);
                        }
                        break;

                    case 'relative':
                        // ×”×ª×™×§×•×Ÿ ×”×’×“×•×œ: ×œ×•×§×—×™× ××ª ×”×—×•×§×¨×™× ×•×”×‘×¡×™×¡ ××ª×•×š finalData ×”××¢×•×“×›×Ÿ!
                        // ××¡× × ×™× ×”×—×•×¦×” ××©×™××•×ª ××¢×¨×›×ª ×©×œ× ×¨×œ×•×•× ×˜×™×•×ª ×œ×—×œ×•×§×”
                        const currentResearchers = Array.from(finalData.categories.keys())
                            .filter(r => r && r !== '××©×™××•×ª ××—×¨×•×ª' && !r.includes('×—×œ×•×§×”') && !r.includes('×—×™×•×‘ ×—×“×©'));

                        if (currentResearchers.length > 0) {
                            // ×—×™×©×•×‘ ×”××©×§×•×œ×•×ª ×œ×¤×™ ×”××¦×‘ *×”× ×•×›×—×™*
                            const weights = currentResearchers.map(r => ({ name: r, base: finalData.categories.get(r) || 0 }));
                            const totalBase = weights.reduce((s, w) => s + w.base, 0);

                            if (totalBase > 0) {
                                const detail = { type:'relative', method:'proportional', taskName: task.name, taskHours: task.hours, totalBase: totalBase, items: [], note: '×—×œ×•×§×” ×™×—×¡×™×ª ×œ×¤×™ ×‘×¡×™×¡ ××¢×•×“×›×Ÿ' };
                                let remaining = task.hours;
                                weights.forEach((w, idx) => {
                                    const raw = task.hours * (w.base / totalBase);
                                    const add = (idx === weights.length - 1) ? remaining : raw;
                                    remaining -= add;
                                    const prev = finalData.categories.get(w.name) || 0;
                                    finalData.categories.set(w.name, prev + add);

                                    // ×©××™×¨×” ×œ×¤×™×¨×•×˜ ×”×—×™×©×•×‘
                                    if (add > 0) {
                                        detail.items.push({ researcher: w.name, baseHours: w.base, weight: (w.base/totalBase), allocated: add });
                                    }
                                });
                                finalData.calculation.relative.push(detail);
                                displayName = `×—×œ×•×§×” ×™×—×¡×™×ª (${weights.filter(w=>w.base>0).length} ×—×•×§×¨×™× ×‘×‘×¡×™×¡)`;
                            } else {
                                // ×× ××™×Ÿ ×‘×¡×™×¡ (×›×œ ×”×—×•×§×¨×™× ×¢×œ 0), ×¢×•×‘×¨×™× ×œ×—×œ×•×§×” ×©×•×•×”
                                const portion = task.hours / currentResearchers.length;
                                const detail = { type:'relative', method:'equal', taskName: task.name, taskHours: task.hours, totalBase: 0, items: [], note: '×—×œ×•×§×” ×™×—×¡×™×ª (××™×Ÿ ×‘×¡×™×¡ - ×‘×•×¦×¢×” ×—×œ×•×§×” ×©×•×•×”)' };
                                let remaining = task.hours;
                                currentResearchers.forEach((r, idx) => {
                                    const add = (idx === currentResearchers.length - 1) ? remaining : portion;
                                    remaining -= add;
                                    const prev = finalData.categories.get(r) || 0;
                                    finalData.categories.set(r, prev + add);
                                    detail.items.push({ researcher: r, baseHours: 0, weight: (1/currentResearchers.length), allocated: add });
                                });
                                finalData.calculation.relative.push(detail);
                                displayName = '×—×œ×•×§×” ×™×—×¡×™×ª (×©×•×•×” ×‘×”×¢×“×¨ ×‘×¡×™×¡)';
                            }
                        } else {
                            displayName = '×—×œ×•×§×” ×™×—×¡×™×ª (×œ×œ× ×—×•×§×¨×™×)';
                            const prev = finalData.categories.get(displayName) || 0;
                            finalData.categories.set(displayName, prev + task.hours);
                        }
                        break;

                    case 'seminar':
                        displayName = '×¡××™× ×¨/×§×•×¨×¡/×”×›×©×¨×”';
                        const prevSem = finalData.categories.get(displayName) || 0;
                        finalData.categories.set(displayName, prevSem + task.hours);
                        break;

                    case 'custom':
                        displayName = customText ? `×—×™×•×‘ ×—×“×© - ${customText}` : '×—×™×•×‘ ×—×“×©';
                        const prevCustom = finalData.categories.get(displayName) || 0;
                        finalData.categories.set(displayName, prevCustom + task.hours);
                        break;

                    default:
                        displayName = '×œ× ××§×•×˜×œ×’';
                        const prevUn = finalData.categories.get(displayName) || 0;
                        finalData.categories.set(displayName, prevUn + task.hours);
                }
                finalData.categorizedTasks.push({ name: task.name, category: displayName, hours: task.hours });
            };

            // ×©×œ×‘ 1: ×”×¨×¦×ª ×”××©×™××•×ª ×”×§×‘×•×¢×•×ª (××¢×“×›×Ÿ ××ª ×”×‘×¡×™×¡)
            fixedTasks.forEach(processSingleTask);

            // ×©×œ×‘ 2: ×”×¨×¦×ª ×”××©×™××•×ª ×”×™×—×¡×™×•×ª (××©×ª××© ×‘×‘×¡×™×¡ ×”××¢×•×“×›×Ÿ)
            relativeTasks.forEach(processSingleTask);

            return finalData;
        }


        function renderFinalReport(data) {
            let html = `
                <div class="report-section">
                    <h3 class="section-title">×¡×š ×”×©×¢×•×ª:</h3>
                    <table class="stats-table">
                        <thead><tr><th></th><th>×¡×”"×› ×©×¢×•×ª</th><th>××—×•×– ××¡×š ×”×©×¢×•×ª</th></tr></thead>
                        <tbody>`;
            data.categories.forEach((hours, category) => {
                const percentage = data.totalHours > 0 ? Math.round((hours / data.totalHours) * 100) : 0;
                html += `<tr><td style="font-weight: 500;">${category}</td><td style="text-align: center;">${formatHours(hours)}</td><td class="percentage-cell">${percentage}%</td></tr>`;
            });
            html += `</tbody></table>
                    <div class="calc-actions">
                        <button class="calc-btn" onclick="toggleCalculation()">×”×¦×’×ª ×—×™×©×•×‘ - ×—×œ×•×§×” ×™×—×¡×™×ª</button>
                    </div>
                    <div id="calc-panel" class="calc-panel" style="display:none;"></div>
                </div>`;

            if (data.categorizedTasks.length > 0) {
                 html += `<div class="report-section"><h3 class="section-title">×¤×™×¨×•×˜ ××©×™××•×ª ×•×¡××™× ×¨×™×:</h3>
                    ${data.categorizedTasks.map(task => `<div class="hours-item other-task"><span class="hours-label">${task.name} <strong>â†’ ${task.category}</strong></span><span class="hours-value">${formatHours(task.hours)}</span></div>`).join('')}
                 </div>`;
            }

            html += `<div class="report-section">
                    <h3 class="section-title">×™××™× ×œ×œ× ×“×™×•×•×—: <span style="color: #3b82f6;">${data.missingDays.length} ×¡×”"×› ×™××™×</span></h3>
                    <div style="display:flex; flex-wrap:wrap; gap:10px;">
                        ${data.missingDays.map(date => `<div style="background:#f1f5f9; padding: 4px 10px; border-radius:15px; font-size:0.9rem;">${date.toLocaleDateString('he-IL')}</div>`).join('') || '<div style="color:#64748b;">××™×Ÿ ×™××™× ×—×¡×¨×™× ×‘×ª×§×•×¤×” ×–×•.</div>'}
                    </div>
                </div>`;

            document.getElementById('final-content').innerHTML = html;
            document.getElementById('chart-section').style.display = 'block';
            document.getElementById('final-actions').style.display = 'flex';
            createPieChart(data);
        }

        function createPieChart(data) {
            const ctx = document.getElementById('hoursChart').getContext('2d');
            if (window.hoursChartInstance) window.hoursChartInstance.destroy();
            const labels = [], chartData = [];
            const colors = ['#3b82f6','#dc2626','#059669','#f59e0b','#8b5cf6','#06b6d4','#84cc16','#f97316','#ec4899','#6366f1','#10b981','#ef4444'];
            data.categories.forEach((hours, category) => {
                if (hours > 0) { labels.push(category); chartData.push(hours); }
            });

            function getContrastColor(hex) {
                if (!hex) return '#fff';
                const h = hex.replace('#', '');
                const bigint = parseInt(h.length === 3 ? h.split('').map(c => c+c).join('') : h, 16);
                const rgb = { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
                const lum = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
                return lum > 0.5 ? '#0f172a' : '#ffffff';
            }

            window.hoursChartInstance = new Chart(ctx, {
                type: 'pie',
                data: { labels, datasets: [{ data: chartData, backgroundColor: colors.slice(0, labels.length), borderWidth: 2, borderColor: '#ffffff' }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { family: 'Heebo' } } },
                        tooltip: { callbacks: { label: c => `${c.label}: ${formatHours(c.parsed)} ×©×¢×•×ª (${Math.round((c.parsed / c.dataset.data.reduce((a,b)=>a+b,0)) * 100)}%)` } }
                    }
                },
                plugins: [{
                    afterDatasetsDraw: (chart) => {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            const total = dataset.data.reduce((a, b) => a + b, 0);
                            meta.data.forEach((element, index) => {
                                const value = dataset.data[index];
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                if (percentage < 5) return;
                                const pos = element.tooltipPosition();
                                const bg = dataset.backgroundColor[index];
                                ctx.save();
                                ctx.fillStyle = getContrastColor(bg);
                                ctx.font = 'bold 14px Heebo';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(`${percentage}%`, pos.x, pos.y);
                                ctx.restore();
                            });
                        });
                    }
                }]
            });
        }

        function toCsv(rows, columns) {
            const escapeCsv = v => {
                const s = v === null || v === undefined ? '' : String(v);
                if (/[",\n]/.test(s)) return '"' + s.replaceAll('"', '""') + '"';
                return s;
            };
            const header = columns.map(c => escapeCsv(c.header)).join(',');
            const lines = rows.map(row => columns.map(c => escapeCsv(row[c.key])).join(','));
            return [header, ...lines].join('\n');
        }

        function download(filename, content, type = 'text/csv;charset=utf-8') {
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        }

        function exportFinalReport() {
            if (!AppState.finalReport || !AppState.selectedEmployee || !AppState.selectedStartDate || !AppState.selectedEndDate) {
                alert('×©×’×™××”: × ×ª×•× ×™ ×”×“×•"×— ××™× × ×–××™× ×™×. × ×¡×” ×œ×”×¤×™×§ ××ª ×”×“×•"×— ××—×“×©.');
                return;
            }

            const { selectedEmployee, selectedStartDate, selectedEndDate, finalReport } = AppState;
            const employeeName = `${selectedEmployee.firstName} ${selectedEmployee.lastName}`;
            const startDateStr = selectedStartDate.toLocaleDateString('he-IL');
            const endDateStr = selectedEndDate.toLocaleDateString('he-IL');
            const dateForFilename = new Date().toISOString().slice(0, 10);
            let csvContent = `×“×•"×— ×©×¢×•×ª ×¢×‘×•×¨:,${employeeName}\n×ª×§×•×¤×”:,${startDateStr} - ${endDateStr}\n\n`;

            const summaryRows = [];
            finalReport.categories.forEach((hours, category) => {
                const percentage = finalReport.totalHours > 0 ? Math.round((hours / finalReport.totalHours) * 100) : 0;
                summaryRows.push({ category, hours: formatHours(hours), percentage: `${percentage}%` });
            });
            summaryRows.push({ category: '×¡×”"×›', hours: formatHours(finalReport.totalHours), percentage: '100%' });
            const summaryColumns = [
                { key: 'category', header: '×§×˜×’×•×¨×™×”' },
                { key: 'hours', header: '×¡×”"×› ×©×¢×•×ª' },
                { key: 'percentage', header: '××—×•×– ××¡×š ×”×©×¢×•×ª' }
            ];
            csvContent += toCsv(summaryRows, summaryColumns) + '\n\n';

            if (finalReport.missingDays.length > 0) {
                const missingDaysRows = finalReport.missingDays.map(date => ({ date: date.toLocaleDateString('he-IL') }));
                csvContent += toCsv(missingDaysRows, [{ key: 'date', header: '×™××™× ×œ×œ× ×“×™×•×•×—' }]);
            } else {
                csvContent += '×œ× × ××¦××• ×™××™× ×œ×œ× ×“×™×•×•×— ×‘×ª×§×•×¤×” ×–×•.\n';
            }

            const filename = `work_report_${employeeName.replace(' ', '_')}_${dateForFilename}.csv`;
            download(filename, csvContent);
        }

        window.openPdfReport = function() {
            if (!AppState.finalReport || !AppState.selectedEmployee || !AppState.selectedStartDate || !AppState.selectedEndDate) {
                alert('×©×’×™××”: × ×ª×•× ×™ ×”×“×•"×— ××™× × ×–××™× ×™×.');
                return;
            }
            const rawResearchers = AppState.reportData?.researchers ? Array.from(AppState.reportData.researchers.entries()) : [];
            const rawSeminarsTotal = AppState.reportData?.seminars?.reduce((sum, t) => sum + (Number(t.hours) || 0), 0) || 0;
            const rawOtherTasksTotal = AppState.reportData?.otherTasks?.reduce((sum, t) => sum + (Number(t.hours) || 0), 0) || 0;

            const serializableReport = {
                totalHours: AppState.finalReport.totalHours,
                categorizedTasks: AppState.finalReport.categorizedTasks,
                missingDays: (AppState.finalReport.missingDays || []).map(d => d.toISOString()),
                categories: Array.from(AppState.finalReport.categories.entries()),
                raw: {
                    researchers: rawResearchers,
                    seminarsTotal: formatHours(rawSeminarsTotal),
                    otherTasksTotal: formatHours(rawOtherTasksTotal)
                }
            };
            const employeeData = encodeURIComponent(JSON.stringify(AppState.selectedEmployee));
            const reportData = encodeURIComponent(JSON.stringify(serializableReport));
            const startDate = AppState.selectedStartDate.toISOString();
            const endDate = AppState.selectedEndDate.toISOString();
            const url = `pdf_report.html?employee=${employeeData}&startDate=${startDate}&endDate=${endDate}&reportData=${reportData}`;
            window.open(url, '_blank', 'width=1024,height=768,scrollbars=yes,resizable=yes');
        };

        window.openDbReport = function() {
            if (!AppState.selectedEmployee || !AppState.selectedStartDate || !AppState.selectedEndDate) {
                alert('×©×’×™××”: ×¤×¨×˜×™ ×”×¢×•×‘×“ ××• ×”×ª××¨×™×›×™× ××™× × ×–××™× ×™×.');
                return;
            }
            const employeeData = encodeURIComponent(JSON.stringify(AppState.selectedEmployee));
            const employeeId = AppState.selectedEmployee.id;
            const startDate = AppState.selectedStartDate.toISOString();
            const endDate = AppState.selectedEndDate.toISOString();
            const url = `raw_data_report.html?employeeId=${employeeId}&employee=${employeeData}&startDate=${startDate}&endDate=${endDate}`;
            window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        };

        function toLocalDateStr(dt) { return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`; }

        function getSundayOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const sunday = new Date(d.getFullYear(), d.getMonth(), d.getDate() - day);
            return sunday;
        }

        // Show-calculation logic
        window.toggleCalculation = function() {
            const panel = document.getElementById('calc-panel');
            if (!panel) return;
            if (panel.style.display === 'none') {
                renderCalculationPanel(AppState.finalReport);
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function renderCalculationPanel(finalData) {
            const panel = document.getElementById('calc-panel');
            if (!panel) return;
            if (!finalData || !finalData.calculation) {
                panel.innerHTML = '<div class="empty-state">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>';
                return;
            }

            let html = '<div class="calc-section"><div class="calc-title">×—×™×©×•×‘×™ ×—×œ×•×§×” ×™×—×¡×™×ª</div>';
            const rel = finalData.calculation.relative || [];
            if (rel.length === 0) {
                html += '<div class="note">×œ× ×‘×•×¦×¢×• ×—×œ×•×§×•×ª ×™×—×¡×™×•×ª ×‘×ª×§×•×¤×” ×–×•.</div>';
            } else {
                html += '<div class="calc-grid">';
                rel.forEach((item, idx) => {
                    html += `<div class="calc-card">
                        <div class="calc-subtitle">${idx + 1}. ${item.taskName || '××©×™××”'} â€” ${formatHours(item.taskHours)} ×©×¢×•×ª (${item.method === 'proportional' ? '×—×œ×•×§×” ×™×—×¡×™×ª' : '×—×œ×•×§×” ×©×•×•×”'})</div>`;
                    if (item.note) html += `<div class="note">${item.note}</div>`;
                    if (item.method === 'proportional') html += `<div class="equation eq-line">×¡×”"×› ×©×¢×•×ª ×‘×¡×™×¡ = ${formatHours(item.totalBase)}</div>`;
                    if (Array.isArray(item.items)) {
                        html += '<div class="chips">';
                        item.items.forEach(it => {
                            html += `<span class="chip">${it.researcher}: ×‘×¡×™×¡ ${formatHours(it.baseHours)}${item.method === 'proportional' ? ` â€¢ ××©×§×œ ${formatHours(it.weight)}` : ''}</span>`;
                        });
                        html += '</div>';
                        item.items.forEach(it => {
                            if (item.method === 'proportional') {
                                html += `<div class="equation eq-line">${it.researcher}: ×©×¢×•×ª ×œ×”×•×¡×¤×” = ${formatHours(item.taskHours)} Ã— (${formatHours(it.baseHours)} / ${formatHours(item.totalBase)}) = ${formatHours(it.allocated)}</div>`;
                            } else {
                                const share = item.items.length ? (1 / item.items.length) : 0;
                                html += `<div class="equation eq-line">${it.researcher}: ×©×¢×•×ª ×œ×”×•×¡×¤×” = ${formatHours(item.taskHours)} Ã— ${formatHours(share)} = ${formatHours(it.allocated)}</div>`;
                            }
                        });
                    }
                    html += '</div>';
                });
                html += '</div>';
            }
            html += '</div>';
            panel.innerHTML = html;
        }


        document.addEventListener('DOMContentLoaded', () => {
            window.firebaseApp.auth.onAuthStateChanged(async (user) => {
                AppState.currentUser = user;
                if (user) {
                    try {
                        const { db, ref, get } = window.firebaseApp;
                        const userRef = ref(db, `users/${user.uid}`);
                        const userSnapshot = await get(userRef);
                        if (userSnapshot.exists()) {
                            const userData = userSnapshot.val();
                            AppState.managerName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                        }
                        AppState.isManager = true; // Simplified for this context
                        document.getElementById('header-name').textContent = ` ${AppState.managerName} `;
                        renderEmployeesList();
                    } catch (error) {
                        console.error('Auth error:', error);
                        document.getElementById('employees-list').innerHTML = '<div class="empty-state">×©×’×™××” ×‘×‘×“×™×§×ª ×”×¨×©××•×ª</div>';
                    }
                } else {
                    document.getElementById('header-name').textContent = ' ××¢×¨×›×ª ×“×™×•×•×— ×¤×¢×™×œ×•×ª';
                    document.getElementById('employees-list').innerHTML = '<div class="empty-state">×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×’×©×ª ×œ××¢×¨×›×ª</div>';
                }
            });
            generateCalendar();
        });

        async function logout() {
            try {
                await window.firebaseApp.signOut(window.firebaseApp.auth);
                window.location.href = 'index.html';
            } catch (err) {
                console.error('Error signing out:', err);
            }
        }

        // Researcher Management Modal Functions
        let modalTempActiveResearchers = [];
        let modalAllResearchers = [];

        async function loadAllResearchers() {
            const { db, ref, get } = window.firebaseApp;
            try {
                // Try to load from global researchers list
                const globalRef = ref(db, 'global/researchers');
                const snapshot = await get(globalRef);
                if (snapshot.exists()) {
                    return snapshot.val() || [];
                }
            } catch (e) {
                console.log('Could not load global researchers, using default list');
            }

            // Fallback to default list from researchers.json structure
            return [
                "××‘×™×˜×œ ×‘×›×¨", "××™×œ×Ÿ ×”×œ×—××™", "××œ×•×Ÿ ×¡×œ×¢", "×’×™××•×¨×’×™ ×©×˜× ×‘×¨×’",
                "×”×™×‘×” ××‘×• ×ª××™×”", "×•×™×§×˜×•×¨ ××œ×—× ×ª×™", "×•×™×§×˜×•×¨ ×‘×œ×•×š", "×™×œ× ×” ×•×™×˜×•×©×§×™×Ÿ",
                "×™×¢×œ ×–×œ×¦×¨", "×™×¤×™×ª ×›×”×Ÿ ××œ×—× ×ª×™", "×™×¤×ª×— ×§×œ×¤", "× ×¢× ×“×•×“",
                "×¡×¤×™ ×•×¨× ×™×§", "×¢×œ×× ×’×××œ", "×¢××™×—×™ ×—×•×¨×©", "×¨× ×™ ××¨×™××œ×™"
            ];
        }

        async function openResearcherModal() {
            if (!AppState.selectedEmployee) {
                alert('×©×’×™××”: ×œ× × ×‘×—×¨ ×¢×•×‘×“');
                return;
            }

            // Load all researchers and current active list
            modalAllResearchers = await loadAllResearchers();
            modalTempActiveResearchers = [...(AppState.selectedEmployee.activeResearchers || [])];

            // Render modal content
            renderModalResearchers();

            // Show modal
            document.getElementById('researcher-modal').classList.add('active');
        }

        function renderModalResearchers() {
            const container = document.getElementById('modal-researchers-list');
            container.innerHTML = '';

            // Get unique list (all researchers from global + any that are already active for this employee)
            const allUniqueResearchers = [...new Set([...modalAllResearchers, ...modalTempActiveResearchers])];

            allUniqueResearchers.forEach(name => {
                const div = document.createElement('div');
                div.className = 'researcher-item';
                const id = `modal-researcher-${name.replace(/\s/g, '_')}`;
                const checked = modalTempActiveResearchers.includes(name) ? 'checked' : '';

                div.innerHTML = `
                    <input type="checkbox" id="${id}" ${checked} onchange="toggleResearcherSelection('${name.replace(/'/g, "\\'")}', this.checked)">
                    <label for="${id}">${name}</label>
                    <button class="btn-select-researcher" onclick="selectResearcherDirectly('${name.replace(/'/g, "\\'")}')">×‘×—×¨/×™</button>
                `;
                container.appendChild(div);
            });
        }

        window.toggleResearcherSelection = function(name, isChecked) {
            if (isChecked) {
                if (!modalTempActiveResearchers.includes(name)) {
                    modalTempActiveResearchers.push(name);
                }
            } else {
                modalTempActiveResearchers = modalTempActiveResearchers.filter(r => r !== name);
            }
        };

        // Function to select researcher directly to the active field without saving
        window.selectResearcherDirectly = function(researcherName) {
            if (!AppState.currentActiveResearcherInput) {
                alert('×× × ×œ×—×¥ ×¢×œ ×©×“×” "×”×—×•×§×¨/×ª ×”×¤×¢×™×œ/×”" ×›×“×™ ×œ×‘×—×•×¨ ×—×•×§×¨');
                return;
            }

            // Check if this is a select dropdown
            if (AppState.currentActiveResearcherInput.tagName === 'SELECT') {
                // Check if the option already exists
                let optionExists = false;
                for (let i = 0; i < AppState.currentActiveResearcherInput.options.length; i++) {
                    if (AppState.currentActiveResearcherInput.options[i].value === researcherName) {
                        optionExists = true;
                        break;
                    }
                }

                // If option doesn't exist, add it dynamically before the "---- ××—×¨ ----" option
                if (!optionExists) {
                    const newOption = document.createElement('option');
                    newOption.value = researcherName;
                    newOption.textContent = researcherName;

                    // Find the "---- ××—×¨ ----" option and insert before it
                    const otherOption = Array.from(AppState.currentActiveResearcherInput.options).find(
                        opt => opt.value === '__other__'
                    );

                    if (otherOption) {
                        AppState.currentActiveResearcherInput.insertBefore(newOption, otherOption);
                    } else {
                        AppState.currentActiveResearcherInput.appendChild(newOption);
                    }
                }
            }

            // Set the researcher name in the input/select field
            AppState.currentActiveResearcherInput.value = researcherName;

            // Close the modal
            closeResearcherModal();

            // Show success message
            showToast(`×”×—×•×§×¨/×ª "${researcherName}" × ×‘×—×¨/×” ×‘×”×¦×œ×—×”`);
        };

        window.addNewResearcherFromModal = function() {
            const input = document.getElementById('modal-new-researcher-name');
            if (!input) return;

            const newName = input.value.trim();
            if (!newName) {
                alert('×× × ×”×–×Ÿ ×©× ×”×—×•×§×¨/×ª');
                return;
            }

            // Check if already exists in the complete list
            if (modalAllResearchers.includes(newName)) {
                alert('×”×—×•×§×¨/×ª ×›×‘×¨ ×§×™×™×/×ª ×‘×¨×©×™××” ×”×›×œ×œ×™×ª');
                input.value = '';
                return;
            }

            // Add to all researchers list
            modalAllResearchers.push(newName);

            // Auto-select the new researcher
            if (!modalTempActiveResearchers.includes(newName)) {
                modalTempActiveResearchers.push(newName);
            }

            // Clear input
            input.value = '';

            // Re-render
            renderModalResearchers();

            // Show success message
            showModalMessage(`×”×—×•×§×¨/×ª "${newName}" × ×•×¡×£/×” ×‘×”×¦×œ×—×”`);
        };

        function showModalMessage(message) {
            // Simple toast-like notification in the modal
            const modalBody = document.querySelector('#researcher-modal .modal-body');
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'background: #10b981; color: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; animation: fadeIn 0.3s ease-in;';
            messageDiv.textContent = message;
            modalBody.insertBefore(messageDiv, modalBody.firstChild);

            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transition = 'opacity 0.3s ease-out';
                setTimeout(() => messageDiv.remove(), 300);
            }, 2000);
        }

        window.saveResearchersFromModal = async function() {
            if (!AppState.selectedEmployee) {
                alert('×©×’×™××”: ×œ× × ×‘×—×¨ ×¢×•×‘×“');
                return;
            }

            try {
                const { db, ref, get, set } = window.firebaseApp;

                console.log('Saving researchers for employee:', AppState.selectedEmployee.id);
                console.log('Active researchers to save:', modalTempActiveResearchers);

                // Update the employee's active researchers
                const employeeActiveRef = ref(db, `users/${AppState.selectedEmployee.id}/activeResearchers`);
                await set(employeeActiveRef, modalTempActiveResearchers);

                console.log('Employee active researchers saved successfully');

                // Update local state
                AppState.selectedEmployee.activeResearchers = [...modalTempActiveResearchers];

                // Try to update global researchers list if we added new ones
                try {
                    const globalRef = ref(db, 'global/researchers');
                    const snapshot = await get(globalRef);
                    const currentGlobal = snapshot.exists() ? snapshot.val() : [];
                    const updatedGlobal = [...new Set([...currentGlobal, ...modalAllResearchers])];

                    console.log('Updating global researchers:', updatedGlobal);
                    await set(globalRef, updatedGlobal);
                    console.log('Global researchers saved successfully');
                } catch (e) {
                    console.log('Could not update global researchers:', e.message);
                }

                // Close modal
                closeResearcherModal();

                // Re-render the intermediate report to show updated active researchers
                if (AppState.reportData) {
                    renderIntermediateReport(AppState.reportData);
                }

                alert('×”×—×•×§×¨×™× ×”×¤×¢×™×œ×™× × ×©××¨×• ×‘×”×¦×œ×—×”!');
            } catch (error) {
                console.error('Error saving researchers:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”×—×•×§×¨×™×: ' + error.message);
            }
        };

        window.closeResearcherModal = function() {
            document.getElementById('researcher-modal').classList.remove('active');
            // Clear input
            const input = document.getElementById('modal-new-researcher-name');
            if (input) input.value = '';
        };

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('researcher-modal');
            if (modal && e.target === modal) {
                closeResearcherModal();
            }
        });

        // Track which active researcher dropdown was clicked - for "×‘×—×¨/×™" button functionality
        document.addEventListener('focus', function(e) {
            // Check if the focused element is an active researcher select dropdown
            if (e.target && e.target.classList && e.target.classList.contains('active-select')) {
                AppState.currentActiveResearcherInput = e.target;
                console.log('Active researcher dropdown focused:', e.target);
            }
        }, true); // Use capture phase to catch the event early
    </script>
</body>
</html>

